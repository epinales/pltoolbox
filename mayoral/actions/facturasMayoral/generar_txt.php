<?php

if (session_status() == PHP_SESSION_NONE) {
    session_start();
}

use PhpOffice\PhpSpreadsheet\Spreadsheet;
use PhpOffice\PhpSpreadsheet\Writer\Xlsx;


function remove_n($txt){
  // error_log(mb_detect_encoding("Ñ"));

  $txt = str_replace(iconv('UTF-8', 'ASCII', "ñ"),"n",$txt);
  $txt = str_replace(iconv('UTF-8', 'ASCII', "Ñ"),"N",$txt);
  return $txt;
}

$folios_uvas_originales = [
  ['11220145','42021201','19805'],
  ['11220145-1','42022201','5934, 19042, 19548, 19796, 19799'],
  ['11220145-2','42029201','19802'],
  ['11220145-31','42029201','19565, 19817'],
  ['11220145-4','42029201','19862'],
  ['11220145-38','42029201','19862'],
  ['11220145-6','43040001','2408, 2465'],
  ['11220145-33','43040001','2407'],
  ['11220145-8','43040001','4410, 4411'],
  ['11220145-9','43040001','5825, 7409'],
  ['11220145-10','43040001','2403'],
  ['11220145-11','43040001','4352'],
  ['11220145-12','43040001','2363, 2784'],
  ['11220145-34','43040001','4352'],
  ['11220145-34','43040001','4351'],
  ['11220145-34','43040001','7336'],
  ['11220145-16','43040001','7417'],
  ['11220145-35','43040001','4353'],
  ['11220145-35','43040001','2337'],
  ['11220145-36','43040001','415, 416, 2410, 2410, 2411, 2411, 2412, 2412, 4412, 4418, 4419, 7412'],
  ['11220145-36','43040001','4475'],
  ['11220145-36','43040001','2481'],
  ['11220145-36','43040001','2414, 2415'],
  ['11220145-23','43040001','4472'],
  ['11220145-24','43040001','7416'],
  ['11220145-25','43040001','2480, 2485'],
  ['11220145-26','43040001','5942'],
  ['11220145-27','43040001','4475'],
  ['11220145-36','43040001','2481'],
  ['11220145-36','43040001','4472'],
  ['11220145-36','43040001','2480'],
  ['1122058','39262099','2941, 4549, 4550, 4956, 4963, 5568, 5710, 5711, 7543'],
  ['1122058-1','39269099','19515, 19752, 19805, 19862'],
  ['1122058-2','96151101','5928, 5929, 10912, 10913'],
  ['11220143','62034295','40'],
  ['11220143-1','62034292','41'],
  ['11220143-2','61012099','43'],
  ['11220143-3','61034304','43'],
  ['11220143-4','61034204','43'],
  ['11220143-5','61034204','43'],
  ['11220143-6','61034304','43'],
  ['11220143-7','62034294','50'],
  ['11220143-8','62034295','50'],
  ['11220143-9','61112008','104'],
  ['11220143-10','61061004','104'],
  ['11220143-11','62092005','113'],
  ['11220143-12','62052092','113'],
  ['11220143-13','61112008','116'],
  ['11220143-14','61061092','116'],
  ['11220143-15','61061004','131'],
  ['11220143-16','61103099','136'],
  ['11220143-17','62052092','146'],
  ['11220143-18','61051099','173'],
  ['11220143-19','61102091','178'],
  ['11220143-20','61112092','308'],
  ['11220143-21','61102099','308'],
  ['11220143-22','61112016','309'],
  ['11220143-23','61102091','309'],
  ['11220143-24','61102091','311'],
  ['11220143-25','61102091','313'],
  ['11220143-26','61102099','314'],
  ['11220143-27','61102091','323'],
  ['11220143-28','61102091','345'],
  ['11220143-29','61102002','350'],
  ['11220143-30','61102091','350'],
  ['11220143-31','61112016','351'],
  ['11220143-32','61102091','351'],
  ['11220143-33','61102002','354'],
  ['11220143-34','62011391','412'],
  ['11220143-35','62011392','412'],
  ['11220143-36','62093091','414'],
  ['11220143-37','62021392','414'],
  ['11220143-38','62029391','416'],
  ['11220143-39','62034295','504'],
  ['11220143-40','62092014','510'],
  ['11220143-41','62034295','510'],
  ['11220143-42','61046292','511'],
  ['11220143-43','62034292','513'],
  ['11220143-44','62034292','517'],
  ['11220143-45','62092014','521'],
  ['11220143-46','62034292','521'],
  ['11220143-47','62092014','563'],
  ['11220143-48','62034292','563'],
  ['11220143-49','62092014','576'],
  ['11220143-50','62046296','576'],
  ['11220143-51','62046296','577'],
  ['11220143-52','62046293','578'],
  ['11220143-53','62046296','578'],
  ['11220143-54','61046291','588'],
  ['11220143-55','61046292','588'],
  ['11220143-56','61034204','705'],
  ['11220143-57','61046292','717'],
  ['11220143-58','61046292','722'],
  ['11220143-59','61034304','725'],
  ['11220143-60','61034304','725'],
  ['11220143-61','61113093','727'],
  ['11220143-62','61046391','727'],
  ['11220143-63','61102002','830'],
  ['11220143-64','61102091','830'],
  ['11220143-65','61102002','842'],
  ['11220143-66','61102091','842'],
  ['11220143-67','61099003','842'],
  ['11220143-68','61099091','842'],
  ['11220143-69','62052091','882'],
  ['11220143-70','62052092','882'],
  ['11220143-71','61112092','918'],
  ['11220143-72','61012099','918'],
  ['11220143-73','61112019','918'],
  ['11220143-74','61034204','918'],
  ['11220143-75','61112019','918'],
  ['11220143-76','61034204','918'],
  ['11220143-77','61113093','918'],
  ['11220143-78','61034304','918'],
  ['11220143-79','61113093','918'],
  ['11220143-80','61034304','918'],
  ['11220143-81','61113093','918'],
  ['11220143-82','61034304','918'],
  ['11220143-83','61112008','2034'],
  ['11220143-84','61112008','2034'],
  ['11220143-85','61112008','2037'],
  ['11220143-86','61051099','2037'],
  ['11220143-87','61112008','2037'],
  ['11220143-88','61051099','2037'],
  ['11220143-89','61112008','2038'],
  ['11220143-90','61051099','2038'],
  ['11220143-91','61112008','2039'],
  ['11220143-92','61051099','2039'],
  ['11220143-93','61112008','2040'],
  ['11220143-94','61051099','2040'],
  ['11220143-95','61112008','2043'],
  ['11220143-96','61051099','2043'],
  ['11220143-97','61112008','2045'],
  ['11220143-98','61051099','2045'],
  ['11220143-99','61112008','2047'],
  ['11220143-100','61051099','2047'],
  ['11220143-101','61112008','2056'],
  ['11220143-102','61061092','2056'],
  ['11220143-103','61112008','2057'],
  ['11220143-104','61112008','2057'],
  ['11220143-105','61112008','2059'],
  ['11220143-106','61061092','2059'],
  ['11220143-107','61112008','2121'],
  ['11220143-108','61051004','2121'],
  ['11220143-109','61112008','2122'],
  ['11220143-110','61051004','2122'],
  ['11220143-111','61112008','2123'],
  ['11220143-112','61051004','2123'],
  ['11220143-113','61112008','2126'],
  ['11220143-114','61051004','2126'],
  ['11220143-115','62092005','2127'],
  ['11220143-116','62052092','2127'],
  ['11220143-117','62092005','2130'],
  ['11220143-118','62052092','2130'],
  ['11220143-119','62092005','2131'],
  ['11220143-120','62052092','2131'],
  ['11220143-121','62092005','2132'],
  ['11220143-122','62052092','2132'],
  ['11220143-123','62092005','2133'],
  ['11220143-124','62052092','2133'],
  ['11220143-125','62092005','2134'],
  ['11220143-126','62052092','2134'],
  ['11220143-127','61112016','2212'],
  ['11220143-128','61113017','2212'],
  ['11220143-129','61112020','2212'],
  ['11220143-130','62092005','2220'],
  ['11220143-131','62063003','2220'],
  ['11220143-818','62093004','2220'],
  ['11220143-816','62045392','2220'],
  ['11220143-134','61113092','2335'],
  ['11220143-135','61112016','2344'],
  ['11220143-136','61102091','2344'],
  ['11220143-137','61112016','2347'],
  ['11220143-138','61102091','2347'],
  ['11220143-139','61113014','2348'],
  ['11220143-140','61103099','2348'],
  ['11220143-141','61112016','2349'],
  ['11220143-142','61102091','2349'],
  ['11220143-143','62093091','2352'],
  ['11220143-144','62019399','2352'],
  ['11220143-145','61112092','2353'],
  ['11220143-146','61102099','2353'],
  ['11220143-147','61112092','2355'],
  ['11220143-148','61012099','2355'],
  ['11220143-149','61113014','2357'],
  ['11220143-150','61062092','2357'],
  ['11220143-809','61113014','2357'],
  ['11220143-802','61062092','2357'],
  ['11220143-153','61113092','2402'],
  ['11220143-154','61103099','2402'],
  ['11220143-155','62092092','2405'],
  ['11220143-156','62029292','2405'],
  ['11220143-157','62093091','2460'],
  ['11220143-158','62093091','2466'],
  ['11220143-159','61112092','2476'],
  ['11220143-160','61033201','2476'],
  ['11220143-161','62093091','2482'],
  ['11220143-162','62011392','2482'],
  ['11220143-163','62093091','2486'],
  ['11220143-164','62011392','2486'],
  ['11220143-165','62093091','2486'],
  ['11220143-166','62011392','2486'],
  ['11220143-167','62093091','2487'],
  ['11220143-168','62011392','2487'],
  ['11220143-169','63079099','2487'],
  ['11220143-170','63079099','2487'],
  ['11220143-171','62093091','2487'],
  ['11220143-172','62011392','2487'],
  ['11220143-173','63079099','2487'],
  ['11220143-174','63079099','2487'],
  ['11220143-175','62093091','2488'],
  ['11220143-176','62011392','2488'],
  ['11220143-177','61112092','2491'],
  ['11220143-178','61012099','2491'],
  ['11220143-179','61112014','2547'],
  ['11220143-180','61112019','2547'],
  ['11220143-181','61112008','2548'],
  ['11220143-182','61112019','2548'],
  ['11220143-183','61112014','2549'],
  ['11220143-184','61112019','2549'],
  ['11220143-185','61112008','2550'],
  ['11220143-186','61112019','2550'],
  ['11220143-187','61112008','2552'],
  ['11220143-188','61112019','2552'],
  ['11220143-189','61112016','2554'],
  ['11220143-190','61112019','2554'],
  ['11220143-191','61112008','2556'],
  ['11220143-192','61112019','2556'],
  ['11220143-193','61112016','2557'],
  ['11220143-194','61112019','2557'],
  ['11220143-195','61112092','2559'],
  ['11220143-196','61112007','2559'],
  ['11220143-197','61112019','2559'],
  ['11220143-198','61112092','2559'],
  ['11220143-199','61113014','2562'],
  ['11220143-200','61113093','2562'],
  ['11220143-201','65050099','2562'],
  ['11220143-202','62092014','2567'],
  ['11220143-203','62092014','2575'],
  ['11220143-204','62034292','2575'],
  ['11220143-205','62092014','2576'],
  ['11220143-206','62034293','2576'],
  ['11220143-207','62092014','2580'],
  ['11220143-208','62034293','2580'],
  ['11220143-209','62092014','2584'],
  ['11220143-210','62034295','2584'],
  ['11220143-211','62092014','2585'],
  ['11220143-212','62034293','2585'],
  ['11220143-213','61112016','2586'],
  ['11220143-214','61102091','2586'],
  ['11220143-215','62092014','2586'],
  ['11220143-216','62034292','2586'],
  ['11220143-217','61119004','2589'],
  ['11220143-218','61046901','2589'],
  ['11220143-219','61112017','2625'],
  ['11220143-220','61113018','2631'],
  ['11220143-221','61112017','2635'],
  ['11220143-222','62092005','2636'],
  ['11220143-223','62092091','2636'],
  ['11220143-224','61112099','2636'],
  ['11220143-225','61112008','2638'],
  ['11220143-226','62092091','2638'],
  ['11220143-227','61112008','2638'],
  ['11220143-228','61112015','2639'],
  ['11220143-229','61112019','2639'],
  ['11220143-230','61112015','2639'],
  ['11220143-231','61112019','2639'],
  ['11220143-232','61112092','2641'],
  ['11220143-233','61112008','2641'],
  ['11220143-234','61112019','2641'],
  ['11220143-235','61112092','2643'],
  ['11220143-807','61112008','2643'],
  ['11220143-237','61112019','2643'],
  ['11220143-238','61112092','2653'],
  ['11220143-239','61112008','2653'],
  ['11220143-240','61112019','2653'],
  ['11220143-241','61112091','2655'],
  ['11220143-242','62034202','2655'],
  ['11220143-243','61112007','2750'],
  ['11220143-244','61112007','2750'],
  ['11220143-245','61112017','2751'],
  ['11220143-246','61112017','2752'],
  ['11220143-247','61112017','2752'],
  ['11220143-248','61112017','2753'],
  ['11220143-249','61112017','2754'],
  ['11220143-250','61112017','2756'],
  ['11220143-251','61112017','2757'],
  ['11220143-252','61112017','2757'],
  ['11220143-253','61112017','2759'],
  ['11220143-254','61112017','2763'],
  ['11220143-255','61112017','2763'],
  ['11220143-256','61112099','2763'],
  ['11220143-257','61112017','2764'],
  ['11220143-258','61112017','2766'],
  ['11220143-259','61112017','2767'],
  ['11220143-260','61112017','2768'],
  ['11220143-261','61112017','2770'],
  ['11220143-262','61112017','2772'],
  ['11220143-263','61112017','2772'],
  ['11220143-264','61112007','2775'],
  ['11220143-265','61112019','2783'],
  ['11220143-266','61046292','2783'],
  ['11220143-267','61112008','2784'],
  ['11220143-268','61061092','2784'],
  ['11220143-269','61112019','2784'],
  ['11220143-270','61046292','2784'],
  ['11220143-271','61112008','2786'],
  ['11220143-272','61112019','2786'],
  ['11220143-273','61112092','2789'],
  ['11220143-274','61061092','2789'],
  ['11220143-808','61112019','2789'],
  ['11220143-800','61046292','2789'],
  ['11220143-277','61112015','2790'],
  ['11220143-278','61061092','2790'],
  ['11220143-279','61112019','2790'],
  ['11220143-280','61046292','2790'],
  ['11220143-281','61112008','2791'],
  ['11220143-282','61061092','2791'],
  ['11220143-283','61112019','2791'],
  ['11220143-284','61046292','2791'],
  ['11220143-285','61112008','2793'],
  ['11220143-286','61061092','2793'],
  ['11220143-287','61112019','2793'],
  ['11220143-288','61046292','2793'],
  ['11220143-289','61113092','2795'],
  ['11220143-290','61023002','2795'],
  ['11220143-291','61112008','2795'],
  ['11220143-292','61061092','2795'],
  ['11220143-293','61112019','2795'],
  ['11220143-294','61046292','2795'],
  ['11220143-295','61112014','2847'],
  ['11220143-296','61112099','2847'],
  ['11220143-297','62092091','2852'],
  ['11220143-298','61112014','2855'],
  ['11220143-299','61112014','2855'],
  ['11220143-300','62093091','2861'],
  ['11220143-301','62092091','2868'],
  ['11220143-302','61113011','2871'],
  ['11220143-303','61112092','2883'],
  ['11220143-304','61012099','2883'],
  ['11220143-305','61113093','2883'],
  ['11220143-306','61034304','2883'],
  ['11220143-307','61112015','2886'],
  ['11220143-308','61102092','2886'],
  ['11220143-309','61112019','2886'],
  ['11220143-310','61034204','2886'],
  ['11220143-311','61112019','2886'],
  ['11220143-312','61034204','2886'],
  ['11220143-313','61112092','2887'],
  ['11220143-314','61012099','2887'],
  ['11220143-315','61112019','2887'],
  ['11220143-316','61034204','2887'],
  ['11220143-317','61112019','2887'],
  ['11220143-318','61034204','2887'],
  ['11220143-319','61112092','2888'],
  ['11220143-320','61012099','2888'],
  ['11220143-321','61112015','2888'],
  ['11220143-322','61102092','2888'],
  ['11220143-323','61112019','2888'],
  ['11220143-324','61034204','2888'],
  ['11220143-325','62093091','2945'],
  ['11220143-326','62044392','2945'],
  ['11220143-327','62092091','2947'],
  ['11220143-328','62044292','2947'],
  ['11220143-329','61113011','2948'],
  ['11220143-330','61044392','2948'],
  ['11220143-331','61112014','2948'],
  ['11220143-332','61044299','2948'],
  ['11220143-333','62093091','2949'],
  ['11220143-334','62044392','2949'],
  ['11220143-335','62093091','2952'],
  ['11220143-336','62044392','2952'],
  ['11220143-337','62093091','2954'],
  ['11220143-338','62044392','2954'],
  ['11220143-339','61112014','2955'],
  ['11220143-340','61044299','2955'],
  ['11220143-341','62093091','2957'],
  ['11220143-342','62044392','2957'],
  ['11220143-343','62093091','2959'],
  ['11220143-344','62044392','2959'],
  ['11220143-345','62092091','2960'],
  ['11220143-346','62044292','2960'],
  ['11220143-347','61113011','2964'],
  ['11220143-348','61112014','2965'],
  ['11220143-349','62092091','2967'],
  ['11220143-350','62044292','2967'],
  ['11220143-351','61112008','2971'],
  ['11220143-352','61061092','2971'],
  ['11220143-353','62093004','2971'],
  ['11220143-354','62045392','2971'],
  ['11220143-355','61102091','4037'],
  ['11220143-356','61102091','4038'],
  ['11220143-357','61102091','4039'],
  ['11220143-358','61102091','4040'],
  ['11220143-359','61102091','4041'],
  ['11220143-360','61102091','4042'],
  ['11220143-361','61102091','4043'],
  ['11220143-362','61102091','4043'],
  ['11220143-363','61102091','4045'],
  ['11220143-364','61102091','4046'],
  ['11220143-365','61102091','4049'],
  ['11220143-366','61102091','4051'],
  ['11220143-803','61102091','4053'],
  ['11220143-368','61102091','4054'],
  ['11220143-369','61062092','4059'],
  ['11220143-370','61102091','4060'],
  ['11220143-371','61061092','4061'],
  ['11220143-804','61102091','4062'],
  ['11220143-373','61061092','4063'],
  ['11220143-374','61102091','4064'],
  ['11220143-375','61102091','4065'],
  ['11220143-376','61102091','4066'],
  ['11220143-377','61102091','4066'],
  ['11220143-378','61102091','4067'],
  ['11220143-379','61102091','4068'],
  ['11220143-380','61102091','4070'],
  ['11220143-381','61051004','4128'],
  ['11220143-382','61051004','4129'],
  ['11220143-383','61051004','4130'],
  ['11220143-384','61051004','4131'],
  ['11220143-385','61051004','4135'],
  ['11220143-386','61051004','4135'],
  ['11220143-387','61051004','4137'],
  ['11220143-388','62052092','4139'],
  ['11220143-389','62159001','4139'],
  ['11220143-390','62052092','4140'],
  ['11220143-391','62052092','4141'],
  ['11220143-392','62052092','4143'],
  ['11220143-393','62052092','4144'],
  ['11220143-394','62052092','4145'],
  ['11220143-395','62052092','4147'],
  ['11220143-396','62064092','4148'],
  ['11220143-397','62064092','4149'],
  ['11220143-398','62064092','4150'],
  ['11220143-399','62063003','4152'],
  ['11220143-400','62046307','4204'],
  ['11220143-401','61046303','4205'],
  ['11220143-402','62046309','4206'],
  ['11220143-403','61061092','4207'],
  ['11220143-404','62046307','4207'],
  ['11220143-405','61102091','4325'],
  ['11220143-406','61103099','4328'],
  ['11220143-806','61103099','4329'],
  ['11220143-408','62019399','4334'],
  ['11220143-409','62019399','4336'],
  ['11220143-410','61012099','4338'],
  ['11220143-411','61013003','4340'],
  ['11220143-412','61013003','4341'],
  ['11220143-413','61103099','4346'],
  ['11220143-414','61102099','4350'],
  ['11220143-415','61103092','4402'],
  ['11220143-416','61102091','4404'],
  ['11220143-417','62029292','4406'],
  ['11220143-418','62021392','4409'],
  ['11220143-419','62021392','4414'],
  ['11220143-420','62021391','4415'],
  ['11220143-421','62021392','4415'],
  ['11220143-422','62029392','4417'],
  ['11220143-423','62021392','4420'],
  ['11220143-424','61022099','4421'],
  ['11220143-425','61102093','4458'],
  ['11220143-426','61102093','4459'],
  ['11220143-427','61102093','4463'],
  ['11220143-428','61102093','4465'],
  ['11220143-429','62019399','4470'],
  ['11220143-430','62011391','4471'],
  ['11220143-431','62011392','4471'],
  ['11220143-432','62011392','4474'],
  ['11220143-433','62011392','4477'],
  ['11220143-434','62011391','4478'],
  ['11220143-435','62011392','4478'],
  ['11220143-436','62011391','4479'],
  ['11220143-437','62011392','4479'],
  ['11220143-438','62011392','4480'],
  ['11220143-439','61012099','4481'],
  ['11220143-440','61012099','4482'],
  ['11220143-441','61012099','4485'],
  ['11220143-442','61012099','4486'],
  ['11220143-443','62034295','4527'],
  ['11220143-444','62034292','4528'],
  ['11220143-445','62034292','4529'],
  ['11220143-446','62034295','4531'],
  ['11220143-447','62034292','4533'],
  ['11220143-448','62034292','4534'],
  ['11220143-449','62034292','4535'],
  ['11220143-450','62171099','4535'],
  ['11220143-814','62034295','4536'],
  ['11220143-452','62034293','4540'],
  ['11220143-453','62034292','4542'],
  ['11220143-454','61046391','4544'],
  ['11220143-455','62046295','4549'],
  ['11220143-800','61046292','4552'],
  ['11220143-457','61102092','4555'],
  ['11220143-801','61046391','4555'],
  ['11220143-802','61046391','4555'],
  ['11220143-460','61046391','4717'],
  ['11220143-461','61046391','4718'],
  ['11220143-462','61046292','4721'],
  ['11220143-463','61103099','4722'],
  ['11220143-464','61046391','4722'],
  ['11220143-465','61102091','4723'],
  ['11220143-466','61046292','4723'],
  ['11220143-467','61061092','4724'],
  ['11220143-468','61046391','4724'],
  ['11220143-469','61061092','4725'],
  ['11220143-470','61046292','4725'],
  ['11220143-471','61102091','4727'],
  ['11220143-472','61046292','4727'],
  ['11220143-473','61102093','4728'],
  ['11220143-474','61046391','4728'],
  ['11220143-475','61103099','4728'],
  ['11220143-476','61102093','4729'],
  ['11220143-477','61046292','4729'],
  ['11220143-478','61046292','4729'],
  ['11220143-479','61046292','4729'],
  ['11220143-480','61046391','4729'],
  ['11220143-481','61103092','4730'],
  ['11220143-482','61046292','4730'],
  ['11220143-483','61102091','4731'],
  ['11220143-484','61046292','4731'],
  ['11220143-485','61102091','4733'],
  ['11220143-486','61046292','4733'],
  ['11220143-487','61012099','4814'],
  ['11220143-488','61034304','4814'],
  ['11220143-489','61034204','4814'],
  ['11220143-490','61012099','4815'],
  ['11220143-491','61034204','4815'],
  ['11220143-492','61034204','4815'],
  ['11220143-493','61034304','4815'],
  ['11220143-494','61102093','4817'],
  ['11220143-495','61034304','4817'],
  ['11220143-496','61034204','4817'],
  ['11220143-497','61034204','4817'],
  ['11220143-498','61012099','4818'],
  ['11220143-499','61034204','4818'],
  ['11220143-500','61012099','4821'],
  ['11220143-501','61034204','4821'],
  ['11220143-502','61034204','4821'],
  ['11220143-503','61022099','4824'],
  ['11220143-800','61046292','4824'],
  ['11220143-505','61022099','4825'],
  ['11220143-800','61046292','4825'],
  ['11220143-507','61103093','4826'],
  ['11220143-508','61103092','4826'],
  ['11220143-509','61046391','4826'],
  ['11220143-817','62045392','4952'],
  ['11220143-511','61045392','4953'],
  ['11220143-512','62045901','4954'],
  ['11220143-513','62045392','4955'],
  ['11220143-514','62045299','4956'],
  ['11220143-515','61045392','4958'],
  ['11220143-516','62045392','4959'],
  ['11220143-517','62171099','4959'],
  ['11220143-799','61044392','4961'],
  ['11220143-519','61044392','4961'],
  ['11220143-520','62044392','4962'],
  ['11220143-521','61044392','4963'],
  ['11220143-522','62044292','4964'],
  ['11220143-523','61044392','4966'],
  ['11220143-524','61044299','4966'],
  ['11220143-525','61044392','4967'],
  ['11220143-526','62044392','4968'],
  ['11220143-815','62044392','4969'],
  ['11220143-528','61044392','4970'],
  ['11220143-529','62044392','4971'],
  ['11220143-530','62044392','4974'],
  ['11220143-531','62171099','4974'],
  ['11220143-532','62044392','4975'],
  ['11220143-533','62044392','4977'],
  ['11220143-534','61044299','4978'],
  ['11220143-535','62044492','4980'],
  ['11220143-536','61044392','4981'],
  ['11220143-537','62171099','4981'],
  ['11220143-538','61044299','4982'],
  ['11220143-539','62044392','4983'],
  ['11220143-540','62044492','4984'],
  ['11220143-541','61044299','4985'],
  ['11220143-542','61044392','4986'],
  ['11220143-543','61103099','4986'],
  ['11220143-544','61044392','4987'],
  ['11220143-545','61044299','4988'],
  ['11220143-799','61044392','4989'],
  ['11220143-547','61044299','4990'],
  ['11220143-548','62063003','4991'],
  ['11220143-549','61045392','4991'],
  ['11220143-550','61102093','4992'],
  ['11220143-551','61045392','4992'],
  ['11220143-552','61102093','4993'],
  ['11220143-553','61045392','4993'],
  ['11220143-554','62044491','5555'],
  ['11220143-555','62044492','5555'],
  ['11220143-556','61051003','7043'],
  ['11220143-557','61051004','7043'],
  ['11220143-558','61102002','7044'],
  ['11220143-559','61102091','7044'],
  ['11220143-560','61102002','7047'],
  ['11220143-561','61102091','7047'],
  ['11220143-562','61102002','7048'],
  ['11220143-563','61102091','7048'],
  ['11220143-564','61102002','7049'],
  ['11220143-565','61102091','7049'],
  ['11220143-566','61102002','7050'],
  ['11220143-567','61102091','7050'],
  ['11220143-568','61102002','7050'],
  ['11220143-569','61102091','7050'],
  ['11220143-570','61102002','7051'],
  ['11220143-571','61102091','7051'],
  ['11220143-572','61102002','7056'],
  ['11220143-573','61102091','7056'],
  ['11220143-574','61102002','7056'],
  ['11220143-575','61102091','7056'],
  ['11220143-576','61102002','7057'],
  ['11220143-577','61102091','7057'],
  ['11220143-578','61103099','7061'],
  ['11220143-579','61102002','7062'],
  ['11220143-580','61061092','7062'],
  ['11220143-581','61102002','7063'],
  ['11220143-582','61102091','7063'],
  ['11220143-583','61102002','7065'],
  ['11220143-584','61102091','7065'],
  ['11220143-585','61102002','7068'],
  ['11220143-586','61102091','7068'],
  ['11220143-587','61099003','7069'],
  ['11220143-588','61099091','7069'],
  ['11220143-589','61102002','7070'],
  ['11220143-590','61102091','7070'],
  ['11220143-591','61102002','7071'],
  ['11220143-592','61102091','7071'],
  ['11220143-593','61102002','7073'],
  ['11220143-594','61099091','7073'],
  ['11220143-595','61102002','7077'],
  ['11220143-804','61102091','7077'],
  ['11220143-597','61102002','7078'],
  ['11220143-598','61091099','7078'],
  ['11220143-599','61102002','7080'],
  ['11220143-600','61102091','7080'],
  ['11220143-601','61051003','7124'],
  ['11220143-602','61051004','7124'],
  ['11220143-603','61051003','7126'],
  ['11220143-604','61051004','7126'],
  ['11220143-605','62052091','7129'],
  ['11220143-606','62052092','7129'],
  ['11220143-607','62052091','7131'],
  ['11220143-608','62052092','7131'],
  ['11220143-609','62052091','7132'],
  ['11220143-610','62052092','7132'],
  ['11220143-611','62052091','7133'],
  ['11220143-612','62052092','7133'],
  ['11220143-613','62052091','7134'],
  ['11220143-614','62052092','7134'],
  ['11220143-615','62064092','7136'],
  ['11220143-616','62063002','7137'],
  ['11220143-617','62063003','7137'],
  ['11220143-618','62064091','7140'],
  ['11220143-619','62064091','7140'],
  ['11220143-620','62064091','7141'],
  ['11220143-621','62064092','7141'],
  ['11220143-622','62064091','7143'],
  ['11220143-623','62064092','7143'],
  ['11220143-624','62046310','7203'],
  ['11220143-625','62046307','7203'],
  ['11220143-626','62171099','7203'],
  ['11220143-627','62019399','7322'],
  ['11220143-628','61103093','7324'],
  ['11220143-629','61103093','7325'],
  ['11220143-630','61103093','7327'],
  ['11220143-631','61103093','7328'],
  ['11220143-810','61143099','7329'],
  ['11220143-811','61143099','7329'],
  ['11220143-634','61103093','7330'],
  ['11220143-805','61103093','7335'],
  ['11220143-636','62029391','7337'],
  ['11220143-637','62029392','7337'],
  ['11220143-638','61103093','7402'],
  ['11220143-639','61103093','7403'],
  ['11220143-640','61102004','7404'],
  ['11220143-641','61023003','7405'],
  ['11220143-642','61023002','7405'],
  ['11220143-643','62029291','7406'],
  ['11220143-644','62029292','7406'],
  ['11220143-645','62029391','7407'],
  ['11220143-646','62021391','7414'],
  ['11220143-647','62021391','7415'],
  ['11220143-648','62029391','7418'],
  ['11220143-649','62021391','7419'],
  ['11220143-650','61102004','7454'],
  ['11220143-651','61102093','7454'],
  ['11220143-652','61102004','7458'],
  ['11220143-653','61102093','7458'],
  ['11220143-654','61102004','7461'],
  ['11220143-655','61102093','7461'],
  ['11220143-656','62019399','7463'],
  ['11220143-657','62011391','7467'],
  ['11220143-658','62011391','7470'],
  ['11220143-659','62019399','7472'],
  ['11220143-660','62011391','7473'],
  ['11220143-661','62011391','7474'],
  ['11220143-662','63079099','7474'],
  ['11220143-663','61012002','7479'],
  ['11220143-664','61012099','7479'],
  ['11220143-665','61034302','7522'],
  ['11220143-666','61034304','7522'],
  ['11220143-804','62034291','7528'],
  ['11220143-668','62034292','7528'],
  ['11220143-813','62034294','7530'],
  ['11220143-814','62034295','7530'],
  ['11220143-671','61046901','7534'],
  ['11220143-672','61046901','7534'],
  ['11220143-673','61046392','7535'],
  ['11220143-674','61046391','7535'],
  ['11220143-675','62046294','7539'],
  ['11220143-676','61102002','7545'],
  ['11220143-803','61102091','7545'],
  ['11220143-678','61046292','7545'],
  ['11220143-679','61046391','7711'],
  ['11220143-680','61046391','7712'],
  ['11220143-681','61102004','7719'],
  ['11220143-682','61046292','7719'],
  ['11220143-683','61103093','7720'],
  ['11220143-684','61046392','7720'],
  ['11220143-685','61046391','7720'],
  ['11220143-686','61102004','7720'],
  ['11220143-687','61012002','7806'],
  ['11220143-688','61012099','7806'],
  ['11220143-689','61034204','7806'],
  ['11220143-690','61102004','7807'],
  ['11220143-691','61034202','7807'],
  ['11220143-692','61034204','7807'],
  ['11220143-693','61012002','7808'],
  ['11220143-694','61034202','7808'],
  ['11220143-695','61034204','7808'],
  ['11220143-696','61013091','7808'],
  ['11220143-697','61102004','7809'],
  ['11220143-698','61034202','7809'],
  ['11220143-699','61034204','7809'],
  ['11220143-700','61034302','7809'],
  ['11220143-701','61034304','7809'],
  ['11220143-702','61023003','7810'],
  ['11220143-703','61023002','7810'],
  ['11220143-704','61046391','7810'],
  ['11220143-705','61045392','7944'],
  ['11220143-706','61045392','7945'],
  ['11220143-707','61045392','7946'],
  ['11220143-708','62045391','7947'],
  ['11220143-709','61045392','7947'],
  ['11220143-710','61045392','7948'],
  ['11220143-817','62045392','7950'],
  ['11220143-712','61045392','7952'],
  ['11220143-713','61044499','7957'],
  ['11220143-714','61044391','7960'],
  ['11220143-715','61044392','7960'],
  ['11220143-716','62044391','7962'],
  ['11220143-717','62044392','7962'],
  ['11220143-718','61044499','7963'],
  ['11220143-719','61102004','7965'],
  ['11220143-720','61044202','7965'],
  ['11220143-721','61044299','7965'],
  ['11220143-722','61102004','7965'],
  ['11220143-798','61044391','7965'],
  ['11220143-799','61044392','7965'],
  ['11220143-725','62044391','7967'],
  ['11220143-726','62044392','7967'],
  ['11220143-727','62044391','7968'],
  ['11220143-728','62044392','7968'],
  ['11220143-729','62044391','7970'],
  ['11220143-730','62044392','7970'],
  ['11220143-731','62044491','7971'],
  ['11220143-732','62044492','7971'],
  ['11220143-733','62044391','7972'],
  ['11220143-734','62044392','7972'],
  ['11220143-735','61103093','7974'],
  ['11220143-736','61103099','7974'],
  ['11220143-737','61044202','7974'],
  ['11220143-738','62044292','7974'],
  ['11220143-739','61044403','7975'],
  ['11220143-740','61044499','7975'],
  ['11220143-741','61044202','7976'],
  ['11220143-742','61044299','7976'],
  ['11220143-743','61112099','9296'],
  ['11220143-744','61112011','9302'],
  ['11220143-745','61112011','9302'],
  ['11220143-746','61112011','9302'],
  ['11220143-747','61112011','9302'],
  ['11220143-748','61112011','9306'],
  ['11220143-749','61112011','9306'],
  ['11220143-750','61112011','9306'],
  ['11220143-751','61112011','9306'],
  ['11220143-752','65050099','9320'],
  ['11220143-753','65050099','9321'],
  ['11220143-754','63013001','9755'],
  ['11220143-755','61112099','9765'],
  ['11220143-756','61112099','9765'],
  ['11220143-757','63013001','9777'],
  ['11220143-758','63013001','9778'],
  ['11220143-759','63013001','9779'],
  ['11220143-760','63014001','9783'],
  ['11220143-761','61112099','10828'],
  ['11220143-762','61152901','10828'],
  ['11220143-763','61112011','10831'],
  ['11220143-764','61159501','10831'],
  ['11220143-765','61112011','10831'],
  ['11220143-766','61159501','10831'],
  ['11220143-767','61112011','10831'],
  ['11220143-768','61159501','10831'],
  ['11220143-769','61071199','10853'],
  ['11220143-770','61071199','10853'],
  ['11220143-771','61071199','10853'],
  ['11220143-772','61071199','10854'],
  ['11220143-773','61071199','10854'],
  ['11220143-774','61071199','10854'],
  ['11220143-775','61071199','10855'],
  ['11220143-776','61071199','10855'],
  ['11220143-777','61071199','10855'],
  ['11220143-778','61152201','10861'],
  ['11220143-779','61152201','10862'],
  ['11220143-780','61152201','10863'],
  ['11220143-781','61152201','10863'],
  ['11220143-782','61152901','10866'],
  ['11220143-812','61152901','10868'],
  ['11220143-784','61159501','10871'],
  ['11220143-785','61159501','10871'],
  ['11220143-786','61159501','10871'],
  ['11220143-787','61159501','10873'],
  ['11220143-788','61159501','10873'],
  ['11220143-789','61159501','10873'],
  ['11220143-790','61159501','10874'],
  ['11220143-791','61159501','10874'],
  ['11220143-792','61159501','10874'],
  ['11220143-793','61159501','10876'],
  ['11220143-794','65050099','10903'],
  ['11220143-795','63079099','19796'],
  ['11220143-796','63079099','19797'],
  ['11220143-797','63079099','19799'],
  ['11220143-798','61112099','19810']
];

$folios_computados = [];

$folios_file = $root . "/pltoolbox/mayoral/resources/TempFiles/items_sin_folios.csv";
$folios_file = fopen($folios_file, "w");

fputcsv($folios_file, ['Linea', 'Fraccion', 'Modelo']);

foreach ($folios_uvas_originales as $uva){
    $folio = $uva[0];
    $fraccion = $uva[1];
    $modelos = explode(', ', $uva[2]);

    foreach($modelos as $modelo){
        $folios_computados[$fraccion . "_" . $modelo] = $folio;
    }
}

$root = $_SERVER['DOCUMENT_ROOT'];

require $root . "/pltoolbox/mayoral/resources/specific_classes/csv_to_utf8.php";
require $root . '/pltoolbox/Resources/PHP/Utilities/initialScript.php';
require $root . '/pltoolbox/Resources/vendor/autoload.php';

$system_callback = [];
$anexo30 = array();
$trato_preferencial = array();
$precios_estimados = array();
$txt_array = array();
$identificadores = array();
$today = date('Y-m-d');
$hm = date('Hi');
$csv_file = array();


$codigo_paises = array(
  "BD"=>"BGD",
  "EG"=>"EGY",
  "ES"=>"ESP",
  "IN"=>"IND",
  "KH"=>"KHM",
  "MA"=>"MAR",
  "PK"=>"PAK",
  "PL"=>"POL",
  "PT"=>"PRT",
  "TR"=>"TUR",
  "VN"=>"VNM",
  "TH"=>"THA",
  "CN"=>"CHN",
  "PT"=>"PRT",
  "TW"=>"TWN",
  "IT"=>"ITA",
  "MM"=>"MMR"
);

$uvnom = "UVNOM" . $_POST['uvnom'];
$fecha_factura = date('d/m/Y', strtotime($_POST['fecha_factura']));
// $fecha_factura = date_format($fecha_factura, 'd/m/Y');
$contenedor = $_POST['contenedor'];

$datos_pbs = array();
$pbs = array();
$nopbs = array();
$pbs_origenes = array();
$pbs_descripciones = array();

$alertas = array();
$advertencias = array();

$anexo30_query = $db->query('SELECT fraccion FROM mayoral_identificadores_anexo30');
while ($item = $anexo30_query->fetch_assoc()) {
  $anexo30[] = $item['fraccion'];
}

$trato_preferencial_query = $db->query('SELECT 3_siglas 3siglas FROM mayoral_trato_preferencial');
while ($item = $trato_preferencial_query->fetch_assoc()) {
  $trato_preferencial[] = $item['3siglas'];
}

$precios_estimados_query = $db->query('SELECT fraccion, precio_estimado FROM mayoral_precio_estimado');
while ($item = $precios_estimados_query->fetch_assoc()) {
  $precios_estimados[$item['fraccion']] = $item['precio_estimado'];
}

$identificadores_aplicables_query = $db->prepare("SELECT * FROM mayoral_identificadores mi LEFT JOIN mayoral_identificadores_fracciones mif ON mi.pk_identificador = mif.fk_identificador WHERE mif.fraccion = ? OR mif.fraccion = ? OR mif.fraccion = ?");
$identificadores_excepciones_query = $db->prepare("SELECT * FROM mayoral_identificadores mi LEFT JOIN mayoral_identificadores_fraccion_excepciones mife ON mi.pk_identificador = mife.fk_identificador WHERE mife.fraccion = ? OR mife.fraccion = ? OR mife.fraccion = ?");

if (!$identificadores_aplicables_query) {
    error_log("Error en prepare queries aplicables: " . $db->error);
}

if (!$identificadores_excepciones_query) {
    error_log("Error en prepare queries exceppciones: " . $db->error);
}


$file = $_FILES;
$text_file = "";

$authorized_files = ['csv'];
$extension = pathinfo($file['file']['name'],PATHINFO_EXTENSION);
$test_extension = in_array($extension, $authorized_files);


$documented_headers = ["﻿AÑO","FACTURA","ARTICULO","PIEZA","RANGO","DESCRIPCION ","DESCRIPCION MX","COMPOSICION","COMP. FORRO","TARIC","MX HS CODE","SUBDIVI","CANTIDAD","PRECIO UN.","IMPORTE TOT,","MONEDA","ORIGEN","PESO NETO","PESO BRUTO","FACERR","SECCION ","MARCA","T1","T2","T3","T4","T5","T6","T7","T8","T9","T10","TK1","TK2","TK3","TK4","TK5","TK6","TK7","TK8","TK9","TK10","C1","C2","C3","C4","C5","C6","C7","C8","C9","C10","PUNTO / PLANA","SEXO","UMC","UMT"
];

$documented_headers = [
  "ANO",
  "FACTURA",
  "ARTICULO",
  "PIEZA",
  "RANGO",
  "DESCRIPCION ",
  "DESCRIPCION MX",
  "COMPOSICION",
  "COMP. FORRO",
  "TARIC",
  "MX HS CODE",
  "SUBDIVI",
  "CANTIDAD",
  "PRECIO UN.",
  "IMPORTE TOT,",
  "MONEDA",
  "ORIGEN",
  "PESO NETO",
  "PESO BRUTO",
  "FACERR",
  "SECCION ",
  "MARCA",
  "T1",
  "T2",
  "T3",
  "T4",
  "T5",
  "T6",
  "T7",
  "T8",
  "T9",
  "T10",
  "TK1",
  "TK2",
  "TK3",
  "TK4",
  "TK5",
  "TK6",
  "TK7",
  "TK8",
  "TK9",
  "TK10",
  "C1",
  "C2",
  "C3",
  "C4",
  "C5",
  "C6",
  "C7",
  "C8",
  "C9",
  "C10",
  "PUNTO / PLANA",
  "SEXO",
  "UMC",
  "UMT",
];


if (!$test_extension) {
  $system_callback['code'] = 500;
  $system_callback['message'] = "Los archivos con extensión $extension no están permitidos. Favor de subir un archivo CSV.";
  exit_script($system_callback);
}

// $conversion = new convert_csv_to_utf8($file['file']['tmp_name']);

// error_log("Conversion: " . var_export($conversion));

$file_handle = fopen($file['file']['tmp_name'], 'r');

$headers = fgetcsv($file_handle,1000);
$invoice_items = array();
$facturas = array();
$valor_factura = array();
$today = date('Y-m-d', strtotime('today'));

$num_headers = count($documented_headers);

for ($i=0; $i < $num_headers; $i++) {
  $internal_header = mb_strtoupper($documented_headers[$i]);
  $document_header = mb_strtoupper($headers[$i]);

  $internal_header = utf8_decode($internal_header);
  $document_header = utf8_decode($document_header);

  $internal_header = $documented_headers[$i];
  $document_header = $headers[$i];

  if (!($internal_header == $document_header)) {
    $system_callback['code'] = 500;
    $system_callback['message'] = "Los encabezados no son correctos. Se esperaba $internal_header; y se encontró: " . $document_header;
    error_log($system_callback['message']);
    error_log(mb_detect_encoding($documented_headers[$i]));
    exit_script($system_callback);
  }
}

while ($row = fgetcsv($file_handle,1000)) {
  $invoice_items[] = $row;
}
fclose($file_handle);

$i = 1;
$permisos = "";
foreach ($invoice_items as $item) {
  $i++;
  $pais_origen = "";
  $identificadores_item = array();
  $aplicar_permiso = false;


  $invoice_num = substr($item[1], 0, 2) . "." . substr($item[1], -3);
  $invoice_num = $item[1];
  $importe_total_factura += (double)$item[14];
  $numero_parte = $invoice_num . $item[2] . $item[3] . $i . $item[10] . $hm . "x";

  //Si la marca es New Born, se debe cambiar por mayoral.
  // $marca = str_replace('MAYORAL     ', 'MAYORAL', $marca);
  $marca = preg_replace('/[^a-zA-Z0-9&](\s)/', '', $item[21]);
  $marca = $marca == "NEWBORN " ? "MAYORAL" : $marca;

  if ($marca == "MAYORAL     ") {
    $advertencias[$numero_parte . "_" . $i] = "La marca es extraña. Marca: $marca";
  }

  //Agregar Y DISEÑO a todas las marcas excepto NUKUTAVAKE (o si hay registros vacíos).
  if (!($marca == 'NUKUTAVAKE' ||$marca == "" ||$marca == " ")) {
    $test = substr($marca, -1);
    if($test == " "){
      $marca .= "Y DISENO";
    } else {
      $marca .= " Y DISENO";
    }
  }

  if ($item[1] == "") {
    continue;
  }


  $c_umt = 0;
  //Calcular Cantidad UMT!!
    //54 es UMC
    //55 es UMT
        // Codigo 9 es Par
        // Codigo 6 es Pieza
  if ($item[54] == $item[55]) { //Si UMC = UMT.
    $c_umt = $item[12];
  } elseif ($item[55] == 1) { //Si UMT = Kilo, usa el peso unitario que viene en la factura.
    $c_umt = $item[17];
  } elseif ($item[55] == 9 && $item[54] == 6) { //Si UMC es Pieza y UMT es PAR. Entonces CANTIDAD COMERCIAL * 2.
    $c_umt = $item[12] / 2;
  } elseif ($item[55] == 6 && $item[54] == 9) { //Si UMC es Par y UMT es Pieza. Entonces Cantidad Comercial / 2.
    $c_umt = $item[12] * 2;
  } else {
    // Record error on this PN.
  }


  if (array_key_exists($item[16], $codigo_paises)) {
    $pais_origen = $codigo_paises[$item[16]];
  } else {
    $alertas[] = array(
      'line_item'=>$i,
      'message'=>"El codigo de país $item[16] no existe en el programa.",
      'comentarios'=>"Porfavor reportarlo a sistemas para corregir."
    );
  }

  $txt_array[$invoice_num]['header'] = array(
    $invoice_num,   //NumeroFactura
    $invoice_num,   //NumeroFactura - reemplaza número de órden
    $fecha_factura,         //Fecha -- Hoy es default
    'ESP',          //Siempre se pone ESP(España) como país facturación
    '',           //Siempre se pone MA(Málaga) como entidad de facturación
    $item[15],      //Moneda --
    'CIF',          //Poner un campo para seleccionar el INCOTERM.
    $importe_total_factura, //Valor Moneda Extranjera
    $importe_total_factura, //Valor Comercial - Factura
    0,0,0,0,0,      //Flete, Seguros, Embalajes, Incrementables, Deducibles
    1,              //FactorMonedaExtranjera
  );

  $txt_array[$invoice_num]['items'][] = array(
    $numero_parte,   //Numero de Parte,
    remove_n($item[6]),                                               //Descripcion MX
    "",                                                     //Descripcion Inglés
    $item[12],                                              //Cantidad UMC
    $item[54],                                              //UMC
    $item[13],                                              //PrecioUnitario
    2,0,                                                    //UnidadPesoUnitario - PesoUnitario
    $item[10],                                              //Fraccion
    $c_umt,                                                 //CantidadUMT
    // "",
    (double) $c_umt / $item[12],                            //FactorAjuste
    $pais_origen,                                           //PaisOrigen,
    0,                                                      //ValorAgregado
    $marca,                                                  //Marca,
    $item[2],                                               //Modelo
    ""                                                       //Serie se manda en blanco.
  );
  $capitulo = substr($item[10], 0,2);
  $partida_fraccion = substr($item[10], 0, 4);

  //Si la fracción esta en el listado de precios estimados, lo revisa para agergar identificador EX o arrojar una alerta.
  if ($item[55] == 1) {
    $precio_unitario_tarifa = $item[14] / $item[17];
  } else {
    $precio_unitario_tarifa = $item[13];
  }
  if (  array_key_exists($item[10], $precios_estimados)) {
    $precio_estimado_item = $precios_estimados[$item[10]];
    if ($precio_unitario_tarifa > $precio_estimado_item) {
      if ($capitulo == 64) {
        $identificadores[$numero_parte . "_" . $i]['identificadores']['EX'] = array($numero_parte, 'EX', '29');
      } elseif ($capitulo >= 50 && $capitulo <= 63) {
        $identificadores[$numero_parte . "_" . $i]['identificadores']['EX'] = array($numero_parte, 'EX', '31');
      } elseif ($capitulo = 94) {
        $identificadores[$numero_parte . "_" . $i]['identificadores']['EX'] = array($numero_parte, 'EX', '31');
      }
    } else {
      $alertas[] = array(
        'line_item'=>$i,
        'message'=>'Este producto esta por debajo del precio estimado.',
        'comentarios'=>"Precio Estimado: $precio_estimado_item - Precio Unitario: $item[13]"
      );
    }
  }

  //Aplicar identificador TL - EMU si eta en la lista de trato preferencial.
  if (in_array($pais_origen, $trato_preferencial)) {
    $identificadores[$numero_parte . "_" . $i]['identificadores']['TL'] = array($numero_parte, 'TL', 'EMU');
  }

  //Si la fracción pertenece al Anexo 30, agrega el identificador MC correspondiene, o arroja una alerta, si no encuentra que MC poner.
  if (in_array($item[10], $anexo30)) {
    if ($marca == "NUKUTAVAKE") {
      $identificadores[$numero_parte . "_" . $i]['identificadores']['MC'] = array($numero_parte, 'MC', '2', '1', '1');
    } elseif ($marca == "MAYORAL Y DISENO" ||$marca == "ABEL & LULA Y DISENO" ||$item[10] == 39262099) {
      $identificadores[$numero_parte . "_" . $i]['identificadores']['MC'] = array($numero_parte, 'MC', '2', '1', '4');
    } elseif ($capitulo == 42) {
      $identificadores[$numero_parte . "_" . $i]['identificadores']['MC'] = array($numero_parte, 'MC', '4', '4');
    } else {
      $advertencias[$numero_parte . "_" . $i] = "No se encontró que identificador aplicar. Marca: $marca";
    }
  }

  $identificadores_aplicables_query->bind_param('sss', $capitulo, $partida_fraccion, $item[10]);
  $identificadores_aplicables_query->execute();
  $identificadores_aplicables = $identificadores_aplicables_query->get_result();

  while ($idents = $identificadores_aplicables->fetch_assoc()) {
    $folio = "";
    $comple1 = $idents['identificador'] == "PB" ? $uvnom : $idents['complemento1'];
    // $comple3 = $idents['identificador'] == "PB" ? "" : $idents['complemento3'];
    $identificadores[$numero_parte . "_" . $i]['identificadores'][$idents['pk_identificador']] = array($numero_parte, $idents['identificador'], $comple1, $idents['complemento2'], $idents['complemento3'], $idents['complemento4']);
    if ($idents['identificador'] == "PB") {
      $clave = $item[10] . "_" . $item[2];
      $folio = $folios_computados[$clave];

      if ($folio == "") {
        $datos_error = [
          $i, //linea,
          $item[10], //fraccion
          $item[2], //modelo
        ];
        fputcsv($folios_file, $datos_error);
        error_log("PERMISOERR: La linea $i ($item[10] - $item[2]) debe tener folio, y no se encontro\n");
      }

      $permisos .=
        $numero_parte . "|" .
        "NM|" .
        $idents['complemento2'] . "|" .
        $folio . "|||"
      ;
    }
  }

  $identificadores_excepciones_query->bind_param('sss', $capitulo, $partida_fraccion, $item[10]);
  $identificadores_excepciones_query->execute();
  $identificadores_excepciones = $identificadores_excepciones_query->get_result();

  while ($idents = $identificadores_excepciones->fetch_assoc()) {
    unset($identificadores[$numero_parte . "_" . $i]['identificadores'][$idents['pk_identificador']]);
  }
  $no_pb = true;
  foreach ($identificadores[$numero_parte . "_" . $i]['identificadores'] as $identificador) {
    if ($identificador[1] == "PB") {
      $no_pb = false;
      $datos_pbs[$identificador[1].",".$identificador[2].",".$identificador[3]]['items']++;
      $datos_pbs[$identificador[1].",".$identificador[2].",".$identificador[3]]['umcs'] += $item[12];
      $datos_pbs[$identificador[1].",".$identificador[2].",".$identificador[3]]['origenes'][]= $pais_origen;
      $datos_pbs[$identificador[1].",".$identificador[2].",".$identificador[3]]['descripciones'][] = remove_n($item[6]);
    }
  }
  if ($no_pb) {
    $datos_pbs['sin_norma']['items']++;
    $datos_pbs['sin_norma']['umcs'] += $item[12];
  }

}

// $pbs_origenes = array_unique($pbs_origenes);
// $pbs_descripciones = array_unique($pbs_descripciones);
// $pbs_origenes_unique = array();
// $pbs_descripciones_unique = array();

// foreach ($pbs_origenes as $origen) {
//   $handler_origen = explode("~", $origen);
//   $pbs_origenes_unique[$handler_origen[0]][] = $handler_origen[1];
// }

// foreach ($pbs_descripciones as $descripcion) {
//   $handler_descripcion = explode("~", $descripcion);
//   $pbs_descripciones_unique[$handler_descripcion[0]][] = $handler_descripcion[1];
// }


$uniq = uniqid();
$csv_file = fopen($root . "/pltoolbox/mayoral/resources/TempFiles/csv_file_{$uniq}.csv", "w");
$identificadores_csv = fopen($root . "/pltoolbox/mayoral/resources/TempFiles/csv_identificadores_{$uniq}.csv", "w");

if (count($alertas) > 0) {
  foreach ($alertas as $alerta) {
    $system_callback['alertas'] .= "<tr><td>$alerta[line_item]</td><td>$alerta[message]</td><td>$alerta[comentarios]</td></tr>";
  }

  $system_callback['code'] = 2;
  exit_script($system_callback);
}

foreach ($txt_array as $factura) {
  foreach ($factura['header'] as $valor_header) {
    $txt_file .= $valor_header . "|";
  }



  fputcsv($csv_file, explode(",", "Numero Factura,	Número Orden,	Fecha Factura,	Pais Factura,	Entidad Factura,	Moneda,	Incoterm,	Valor Total Factura,	Valor Total USD,	Flete,	Seguros,	Embalajes,	Incrementables,	Deducibles,	Factor Moneda Extranjera"));
  fputcsv($csv_file, $factura['header']);

  fputcsv($csv_file, explode(",","Numero Parte,	Descripcion Español,	Descripcion Ingles,	Cantidad UMC,	UMC,	Precio Unitario,	Unidad Peso Unitario,	Peso Unitario,	Fraccion,	Cantidad UMT,	UMT,	Pais Origen,	Valor Agregado,	Marca,	Modelo,	Serie"));

  foreach ($factura['items'] as $item) {
    foreach ($item as $valor_item) {
      $txt_file .= rtrim($valor_item) . "|";
    }
    fputcsv($csv_file, $item);

  }
  $txt_file = rtrim($txt_file, "|");
  // $txt_file = substr($txt_file, 0, -1);
  $txt_file .= "^";
}

$txt_file = rtrim($txt_file, "^");
$txt_file .= "~";

$identificadores_print = "";

foreach ($identificadores as $identificadores_item) {
  foreach($identificadores_item['identificadores'] as $identificador_parte){
    fputcsv($identificadores_csv, $identificador_parte);
    for ($i=0; $i < 7; $i++) {
      $identificadorparte = isset($identificador_parte[$i]) ? $identificador_parte[$i] : "";
      $txt_file .= $identificadorparte . "|";
    }
  }
}

$txt_file .= "@$permisos";

$txt_file = str_replace("ñ","n",$txt_file);
$txt_file = str_replace("Ñ","N",$txt_file);

$txt_file_path = $root . "/pltoolbox/mayoral/resources/TempFiles/txt_file_{$uniq}.txt";
file_put_contents($txt_file_path, $txt_file);
fclose($csv_file);

foreach ($datos_pbs as $norma_id => $datos_norma) {
  $datos_pbs[$norma_id]['origenes'] = array_unique($datos_pbs[$norma_id]['origenes']);
  $datos_pbs[$norma_id]['descripciones'] = array_unique($datos_pbs[$norma_id]['descripciones']);
}

$pbs_origenes_unique = array_unique($pbs_origenes);
$pbs_descripciones_unique = array_unique($pbs_descripciones);

$xls = new Spreadsheet();
$xlsActive = $xls->getActiveSheet();
$rows_var = "FGHIJKLMNOPQRSTUVWXY";

$xlsActive->setCellValue('B3', "Norma");
$xlsActive->setCellValue('C3', "Items");
$xlsActive->setCellValue('D3', "UMCs");

$i = 3;
foreach ($datos_pbs as $norma => $datos) {
  $i++;
  $xlsActive->setCellValue("B$i", utf8_encode($norma));
  $xlsActive->setCellValue("C$i", utf8_encode($datos['items']));
  $xlsActive->setCellValue("D$i", utf8_encode($datos['umcs']));
}


$c1=0;
foreach ($datos_pbs as $norma => $datos) {

  if ($norma == "sin_norma") {
    continue;
  }

  $r=2;
  $c2=$c1+1;
  $xlsActive->mergeCells("$rows_var[$c1]$r:$rows_var[$c2]$r");
  $xlsActive->setCellValue("$rows_var[$c1]$r", utf8_encode($norma));
  $r_data = 3;
  $xlsActive->setCellValue("$rows_var[$c1]$r_data", "Origenes");
  foreach ($datos['origenes'] as $origen) {
    $r_data++;
    $xlsActive->setCellValue("$rows_var[$c1]$r_data", utf8_encode($origen));
  }
  $r_data = 3;
  $xlsActive->setCellValue("$rows_var[$c2]$r_data", "Descripciones");
  foreach ($datos['descripciones'] as $descripcion) {
    $r_data++;
    $xlsActive->setCellValue("$rows_var[$c2]$r_data", utf8_encode($descripcion));
  }

  $c1++;
  $c1++;
}

$columns = strlen($rows_var);
for ($i=0; $i < $columns; $i++) {
  $xlsActive->getColumnDimension($rows_var[$i])->setAutoSize(true);
}


$writeXLS = new \PhpOffice\PhpSpreadsheet\Writer\Xlsx($xls);

$xls_file = $root . "/pltoolbox/mayoral/resources/TempFiles/uvas_file_{$uniq}.xlsx";
// $file = "/home/esantos/Crons/TempFiles/detalle_pedimentos_$cliente_rfc.xlsx";
$writeXLS->save($xls_file);


// $system_callback['pbs'] = $datos_pbs;
$system_callback['code'] = 1;
$system_callback['uniq'] = $uniq;
// $system_callback['advertencias'] = $advertencias;

exit_script($system_callback);




 ?>
