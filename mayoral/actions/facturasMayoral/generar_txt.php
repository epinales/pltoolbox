<?php

if (session_status() == PHP_SESSION_NONE) {
    session_start();
}

use PhpOffice\PhpSpreadsheet\Spreadsheet;
use PhpOffice\PhpSpreadsheet\Writer\Xlsx;


function remove_n($txt){
  // error_log(mb_detect_encoding("Ñ"));

  // $txt = str_replace(iconv('UTF-8', 'ASCII', "ñ"),"n",$txt);
  // $txt = str_replace(iconv('UTF-8', 'ASCII', "Ñ"),"N",$txt);
  return $txt;
}

$folios_uvas = [
  "39262099_4549" => "1122047",
  "39262099_4956" => "1122047",
  "39262099_4963" => "1122047",
  "39262099_19805" => "1122047",
  "96151101_19805" => "1122047-1",
  "62034295_40" => "11220143",
  "62034292_41" => "11220143-1",
  "61012099_43" => "11220143-2",
  "61034304_43" => "11220143-3",
  "61034204_43" => "11220143-4",
  "61034204_43" => "11220143-5",
  "61034304_43" => "11220143-6",
  "62034294_50" => "11220143-7",
  "62034295_50" => "11220143-8",
  "61112008_104" => "11220143-9",
  "61061004_104" => "11220143-10",
  "62092005_113" => "11220143-11",
  "62052092_113" => "11220143-12",
  "61112008_116" => "11220143-13",
  "61061092_116" => "11220143-14",
  "61061004_131" => "11220143-15",
  "61103099_136" => "11220143-16",
  "62052092_146" => "11220143-17",
  "61051099_173" => "11220143-18",
  "61102091_178" => "11220143-19",
  "61112092_308" => "11220143-20",
  "61102099_308" => "11220143-21",
  "61112016_309" => "11220143-22",
  "61102091_309" => "11220143-23",
  "61102091_311" => "11220143-24",
  "61102091_313" => "11220143-25",
  "61102099_314" => "11220143-26",
  "61102091_323" => "11220143-27",
  "61102091_345" => "11220143-28",
  "61102002_350" => "11220143-29",
  "61102091_350" => "11220143-30",
  "61112016_351" => "11220143-31",
  "61102091_351" => "11220143-32",
  "61102002_354" => "11220143-33",
  "62011391_412" => "11220143-34",
  "62011392_412" => "11220143-35",
  "62093091_414" => "11220143-36",
  "62021392_414" => "11220143-37",
  "62029391_416" => "11220143-38",
  "62034295_504" => "11220143-39",
  "62092014_510" => "11220143-40",
  "62034295_510" => "11220143-41",
  "61046292_511" => "11220143-42",
  "62034292_513" => "11220143-43",
  "62034292_517" => "11220143-44",
  "62092014_521" => "11220143-45",
  "62034292_521" => "11220143-46",
  "62092014_563" => "11220143-47",
  "62034292_563" => "11220143-48",
  "62092014_576" => "11220143-49",
  "62046296_576" => "11220143-50",
  "62046296_577" => "11220143-51",
  "62046293_578" => "11220143-52",
  "62046296_578" => "11220143-53",
  "61046291_588" => "11220143-54",
  "61046292_588" => "11220143-55",
  "61034204_705" => "11220143-56",
  "61046292_717" => "11220143-57",
  "61046292_722" => "11220143-58",
  "61034304_725" => "11220143-59",
  "61034304_725" => "11220143-60",
  "61113093_727" => "11220143-61",
  "61046391_727" => "11220143-62",
  "61102002_830" => "11220143-63",
  "61102091_830" => "11220143-64",
  "61102002_842" => "11220143-65",
  "61102091_842" => "11220143-66",
  "61099003_842" => "11220143-67",
  "61099091_842" => "11220143-68",
  "62052091_882" => "11220143-69",
  "62052092_882" => "11220143-70",
  "61112092_918" => "11220143-71",
  "61012099_918" => "11220143-72",
  "61112019_918" => "11220143-73",
  "61034204_918" => "11220143-74",
  "61112019_918" => "11220143-75",
  "61034204_918" => "11220143-76",
  "61113093_918" => "11220143-77",
  "61034304_918" => "11220143-78",
  "61113093_918" => "11220143-79",
  "61034304_918" => "11220143-80",
  "61113093_918" => "11220143-81",
  "61034304_918" => "11220143-82",
  "61112008_2034" => "11220143-83",
  "61112008_2034" => "11220143-84",
  "61112008_2037" => "11220143-85",
  "61051099_2037" => "11220143-86",
  "61112008_2037" => "11220143-87",
  "61051099_2037" => "11220143-88",
  "61112008_2038" => "11220143-89",
  "61051099_2038" => "11220143-90",
  "61112008_2039" => "11220143-91",
  "61051099_2039" => "11220143-92",
  "61112008_2040" => "11220143-93",
  "61051099_2040" => "11220143-94",
  "61112008_2043" => "11220143-95",
  "61051099_2043" => "11220143-96",
  "61112008_2045" => "11220143-97",
  "61051099_2045" => "11220143-98",
  "61112008_2047" => "11220143-99",
  "61051099_2047" => "11220143-100",
  "61112008_2056" => "11220143-101",
  "61061092_2056" => "11220143-102",
  "61112008_2057" => "11220143-103",
  "61112008_2057" => "11220143-104",
  "61112008_2059" => "11220143-105",
  "61061092_2059" => "11220143-106",
  "61112008_2121" => "11220143-107",
  "61051004_2121" => "11220143-108",
  "61112008_2122" => "11220143-109",
  "61051004_2122" => "11220143-110",
  "61112008_2123" => "11220143-111",
  "61051004_2123" => "11220143-112",
  "61112008_2126" => "11220143-113",
  "61051004_2126" => "11220143-114",
  "62092005_2127" => "11220143-115",
  "62052092_2127" => "11220143-116",
  "62092005_2130" => "11220143-117",
  "62052092_2130" => "11220143-118",
  "62092005_2131" => "11220143-119",
  "62052092_2131" => "11220143-120",
  "62092005_2132" => "11220143-121",
  "62052092_2132" => "11220143-122",
  "62092005_2133" => "11220143-123",
  "62052092_2133" => "11220143-124",
  "62092005_2134" => "11220143-125",
  "62052092_2134" => "11220143-126",
  "61112016_2212" => "11220143-127",
  "61113017_2212" => "11220143-128",
  "61112020_2212" => "11220143-129",
  "62092005_2220" => "11220143-130",
  "62063003_2220" => "11220143-131",
  "62093004_2220" => "11220143-818",
  "62045392_2220" => "11220143-816",
  "61113092_2335" => "11220143-134",
  "61112016_2344" => "11220143-135",
  "61102091_2344" => "11220143-136",
  "61112016_2347" => "11220143-137",
  "61102091_2347" => "11220143-138",
  "61113014_2348" => "11220143-139",
  "61103099_2348" => "11220143-140",
  "61112016_2349" => "11220143-141",
  "61102091_2349" => "11220143-142",
  "62093091_2352" => "11220143-143",
  "62019399_2352" => "11220143-144",
  "61112092_2353" => "11220143-145",
  "61102099_2353" => "11220143-146",
  "61112092_2355" => "11220143-147",
  "61012099_2355" => "11220143-148",
  "61113014_2357" => "11220143-149",
  "61062092_2357" => "11220143-150",
  "61113014_2357" => "11220143-809",
  "61062092_2357" => "11220143-802",
  "61113092_2402" => "11220143-153",
  "61103099_2402" => "11220143-154",
  "62092092_2405" => "11220143-155",
  "62029292_2405" => "11220143-156",
  "62093091_2460" => "11220143-157",
  "62093091_2466" => "11220143-158",
  "61112092_2476" => "11220143-159",
  "61033201_2476" => "11220143-160",
  "62093091_2482" => "11220143-161",
  "62011392_2482" => "11220143-162",
  "62093091_2486" => "11220143-163",
  "62011392_2486" => "11220143-164",
  "62093091_2486" => "11220143-165",
  "62011392_2486" => "11220143-166",
  "62093091_2487" => "11220143-167",
  "62011392_2487" => "11220143-168",
  "63079099_2487" => "11220143-169",
  "63079099_2487" => "11220143-170",
  "62093091_2487" => "11220143-171",
  "62011392_2487" => "11220143-172",
  "63079099_2487" => "11220143-173",
  "63079099_2487" => "11220143-174",
  "62093091_2488" => "11220143-175",
  "62011392_2488" => "11220143-176",
  "61112092_2491" => "11220143-177",
  "61012099_2491" => "11220143-178",
  "61112014_2547" => "11220143-179",
  "61112019_2547" => "11220143-180",
  "61112008_2548" => "11220143-181",
  "61112019_2548" => "11220143-182",
  "61112014_2549" => "11220143-183",
  "61112019_2549" => "11220143-184",
  "61112008_2550" => "11220143-185",
  "61112019_2550" => "11220143-186",
  "61112008_2552" => "11220143-187",
  "61112019_2552" => "11220143-188",
  "61112016_2554" => "11220143-189",
  "61112019_2554" => "11220143-190",
  "61112008_2556" => "11220143-191",
  "61112019_2556" => "11220143-192",
  "61112016_2557" => "11220143-193",
  "61112019_2557" => "11220143-194",
  "61112092_2559" => "11220143-195",
  "61112007_2559" => "11220143-196",
  "61112019_2559" => "11220143-197",
  "61112092_2559" => "11220143-198",
  "61113014_2562" => "11220143-199",
  "61113093_2562" => "11220143-200",
  "65050099_2562" => "11220143-201",
  "62092014_2567" => "11220143-202",
  "62092014_2575" => "11220143-203",
  "62034292_2575" => "11220143-204",
  "62092014_2576" => "11220143-205",
  "62034293_2576" => "11220143-206",
  "62092014_2580" => "11220143-207",
  "62034293_2580" => "11220143-208",
  "62092014_2584" => "11220143-209",
  "62034295_2584" => "11220143-210",
  "62092014_2585" => "11220143-211",
  "62034293_2585" => "11220143-212",
  "61112016_2586" => "11220143-213",
  "61102091_2586" => "11220143-214",
  "62092014_2586" => "11220143-215",
  "62034292_2586" => "11220143-216",
  "61119004_2589" => "11220143-217",
  "61046901_2589" => "11220143-218",
  "61112017_2625" => "11220143-219",
  "61113018_2631" => "11220143-220",
  "61112017_2635" => "11220143-221",
  "62092005_2636" => "11220143-222",
  "62092091_2636" => "11220143-223",
  "61112099_2636" => "11220143-224",
  "61112008_2638" => "11220143-225",
  "62092091_2638" => "11220143-226",
  "61112008_2638" => "11220143-227",
  "61112015_2639" => "11220143-228",
  "61112019_2639" => "11220143-229",
  "61112015_2639" => "11220143-230",
  "61112019_2639" => "11220143-231",
  "61112092_2641" => "11220143-232",
  "61112008_2641" => "11220143-233",
  "61112019_2641" => "11220143-234",
  "61112092_2643" => "11220143-235",
  "61112008_2643" => "11220143-807",
  "61112019_2643" => "11220143-237",
  "61112092_2653" => "11220143-238",
  "61112008_2653" => "11220143-239",
  "61112019_2653" => "11220143-240",
  "61112091_2655" => "11220143-241",
  "62034202_2655" => "11220143-242",
  "61112007_2750" => "11220143-243",
  "61112007_2750" => "11220143-244",
  "61112017_2751" => "11220143-245",
  "61112017_2752" => "11220143-246",
  "61112017_2752" => "11220143-247",
  "61112017_2753" => "11220143-248",
  "61112017_2754" => "11220143-249",
  "61112017_2756" => "11220143-250",
  "61112017_2757" => "11220143-251",
  "61112017_2757" => "11220143-252",
  "61112017_2759" => "11220143-253",
  "61112017_2763" => "11220143-254",
  "61112017_2763" => "11220143-255",
  "61112099_2763" => "11220143-256",
  "61112017_2764" => "11220143-257",
  "61112017_2766" => "11220143-258",
  "61112017_2767" => "11220143-259",
  "61112017_2768" => "11220143-260",
  "61112017_2770" => "11220143-261",
  "61112017_2772" => "11220143-262",
  "61112017_2772" => "11220143-263",
  "61112007_2775" => "11220143-264",
  "61112019_2783" => "11220143-265",
  "61046292_2783" => "11220143-266",
  "61112008_2784" => "11220143-267",
  "61061092_2784" => "11220143-268",
  "61112019_2784" => "11220143-269",
  "61046292_2784" => "11220143-270",
  "61112008_2786" => "11220143-271",
  "61112019_2786" => "11220143-272",
  "61112092_2789" => "11220143-273",
  "61061092_2789" => "11220143-274",
  "61112019_2789" => "11220143-808",
  "61046292_2789" => "11220143-800",
  "61112015_2790" => "11220143-277",
  "61061092_2790" => "11220143-278",
  "61112019_2790" => "11220143-279",
  "61046292_2790" => "11220143-280",
  "61112008_2791" => "11220143-281",
  "61061092_2791" => "11220143-282",
  "61112019_2791" => "11220143-283",
  "61046292_2791" => "11220143-284",
  "61112008_2793" => "11220143-285",
  "61061092_2793" => "11220143-286",
  "61112019_2793" => "11220143-287",
  "61046292_2793" => "11220143-288",
  "61113092_2795" => "11220143-289",
  "61023002_2795" => "11220143-290",
  "61112008_2795" => "11220143-291",
  "61061092_2795" => "11220143-292",
  "61112019_2795" => "11220143-293",
  "61046292_2795" => "11220143-294",
  "61112014_2847" => "11220143-295",
  "61112099_2847" => "11220143-296",
  "62092091_2852" => "11220143-297",
  "61112014_2855" => "11220143-298",
  "61112014_2855" => "11220143-299",
  "62093091_2861" => "11220143-300",
  "62092091_2868" => "11220143-301",
  "61113011_2871" => "11220143-302",
  "61112092_2883" => "11220143-303",
  "61012099_2883" => "11220143-304",
  "61113093_2883" => "11220143-305",
  "61034304_2883" => "11220143-306",
  "61112015_2886" => "11220143-307",
  "61102092_2886" => "11220143-308",
  "61112019_2886" => "11220143-309",
  "61034204_2886" => "11220143-310",
  "61112019_2886" => "11220143-311",
  "61034204_2886" => "11220143-312",
  "61112092_2887" => "11220143-313",
  "61012099_2887" => "11220143-314",
  "61112019_2887" => "11220143-315",
  "61034204_2887" => "11220143-316",
  "61112019_2887" => "11220143-317",
  "61034204_2887" => "11220143-318",
  "61112092_2888" => "11220143-319",
  "61012099_2888" => "11220143-320",
  "61112015_2888" => "11220143-321",
  "61102092_2888" => "11220143-322",
  "61112019_2888" => "11220143-323",
  "61034204_2888" => "11220143-324",
  "62093091_2945" => "11220143-325",
  "62044392_2945" => "11220143-326",
  "62092091_2947" => "11220143-327",
  "62044292_2947" => "11220143-328",
  "61113011_2948" => "11220143-329",
  "61044392_2948" => "11220143-330",
  "61112014_2948" => "11220143-331",
  "61044299_2948" => "11220143-332",
  "62093091_2949" => "11220143-333",
  "62044392_2949" => "11220143-334",
  "62093091_2952" => "11220143-335",
  "62044392_2952" => "11220143-336",
  "62093091_2954" => "11220143-337",
  "62044392_2954" => "11220143-338",
  "61112014_2955" => "11220143-339",
  "61044299_2955" => "11220143-340",
  "62093091_2957" => "11220143-341",
  "62044392_2957" => "11220143-342",
  "62093091_2959" => "11220143-343",
  "62044392_2959" => "11220143-344",
  "62092091_2960" => "11220143-345",
  "62044292_2960" => "11220143-346",
  "61113011_2964" => "11220143-347",
  "61112014_2965" => "11220143-348",
  "62092091_2967" => "11220143-349",
  "62044292_2967" => "11220143-350",
  "61112008_2971" => "11220143-351",
  "61061092_2971" => "11220143-352",
  "62093004_2971" => "11220143-353",
  "62045392_2971" => "11220143-354",
  "61102091_4037" => "11220143-355",
  "61102091_4038" => "11220143-356",
  "61102091_4039" => "11220143-357",
  "61102091_4040" => "11220143-358",
  "61102091_4041" => "11220143-359",
  "61102091_4042" => "11220143-360",
  "61102091_4043" => "11220143-361",
  "61102091_4043" => "11220143-362",
  "61102091_4045" => "11220143-363",
  "61102091_4046" => "11220143-364",
  "61102091_4049" => "11220143-365",
  "61102091_4051" => "11220143-366",
  "61102091_4053" => "11220143-803",
  "61102091_4054" => "11220143-368",
  "61062092_4059" => "11220143-369",
  "61102091_4060" => "11220143-370",
  "61061092_4061" => "11220143-371",
  "61102091_4062" => "11220143-804",
  "61061092_4063" => "11220143-373",
  "61102091_4064" => "11220143-374",
  "61102091_4065" => "11220143-375",
  "61102091_4066" => "11220143-376",
  "61102091_4066" => "11220143-377",
  "61102091_4067" => "11220143-378",
  "61102091_4068" => "11220143-379",
  "61102091_4070" => "11220143-380",
  "61051004_4128" => "11220143-381",
  "61051004_4129" => "11220143-382",
  "61051004_4130" => "11220143-383",
  "61051004_4131" => "11220143-384",
  "61051004_4135" => "11220143-385",
  "61051004_4135" => "11220143-386",
  "61051004_4137" => "11220143-387",
  "62052092_4139" => "11220143-388",
  "62159001_4139" => "11220143-389",
  "62052092_4140" => "11220143-390",
  "62052092_4141" => "11220143-391",
  "62052092_4143" => "11220143-392",
  "62052092_4144" => "11220143-393",
  "62052092_4145" => "11220143-394",
  "62052092_4147" => "11220143-395",
  "62064092_4148" => "11220143-396",
  "62064092_4149" => "11220143-397",
  "62064092_4150" => "11220143-398",
  "62063003_4152" => "11220143-399",
  "62046307_4204" => "11220143-400",
  "61046303_4205" => "11220143-401",
  "62046309_4206" => "11220143-402",
  "61061092_4207" => "11220143-403",
  "62046307_4207" => "11220143-404",
  "61102091_4325" => "11220143-405",
  "61103099_4328" => "11220143-406",
  "61103099_4329" => "11220143-806",
  "62019399_4334" => "11220143-408",
  "62019399_4336" => "11220143-409",
  "61012099_4338" => "11220143-410",
  "61013003_4340" => "11220143-411",
  "61013003_4341" => "11220143-412",
  "61103099_4346" => "11220143-413",
  "61102099_4350" => "11220143-414",
  "61103092_4402" => "11220143-415",
  "61102091_4404" => "11220143-416",
  "62029292_4406" => "11220143-417",
  "62021392_4409" => "11220143-418",
  "62021392_4414" => "11220143-419",
  "62021391_4415" => "11220143-420",
  "62021392_4415" => "11220143-421",
  "62029392_4417" => "11220143-422",
  "62021392_4420" => "11220143-423",
  "61022099_4421" => "11220143-424",
  "61102093_4458" => "11220143-425",
  "61102093_4459" => "11220143-426",
  "61102093_4463" => "11220143-427",
  "61102093_4465" => "11220143-428",
  "62019399_4470" => "11220143-429",
  "62011391_4471" => "11220143-430",
  "62011392_4471" => "11220143-431",
  "62011392_4474" => "11220143-432",
  "62011392_4477" => "11220143-433",
  "62011391_4478" => "11220143-434",
  "62011392_4478" => "11220143-435",
  "62011391_4479" => "11220143-436",
  "62011392_4479" => "11220143-437",
  "62011392_4480" => "11220143-438",
  "61012099_4481" => "11220143-439",
  "61012099_4482" => "11220143-440",
  "61012099_4485" => "11220143-441",
  "61012099_4486" => "11220143-442",
  "62034295_4527" => "11220143-443",
  "62034292_4528" => "11220143-444",
  "62034292_4529" => "11220143-445",
  "62034295_4531" => "11220143-446",
  "62034292_4533" => "11220143-447",
  "62034292_4534" => "11220143-448",
  "62034292_4535" => "11220143-449",
  "62171099_4535" => "11220143-450",
  "62034295_4536" => "11220143-814",
  "62034293_4540" => "11220143-452",
  "62034292_4542" => "11220143-453",
  "61046391_4544" => "11220143-454",
  "62046295_4549" => "11220143-455",
  "61046292_4552" => "11220143-800",
  "61102092_4555" => "11220143-457",
  "61046391_4555" => "11220143-801",
  "61046391_4555" => "11220143-802",
  "61046391_4717" => "11220143-460",
  "61046391_4718" => "11220143-461",
  "61046292_4721" => "11220143-462",
  "61103099_4722" => "11220143-463",
  "61046391_4722" => "11220143-464",
  "61102091_4723" => "11220143-465",
  "61046292_4723" => "11220143-466",
  "61061092_4724" => "11220143-467",
  "61046391_4724" => "11220143-468",
  "61061092_4725" => "11220143-469",
  "61046292_4725" => "11220143-470",
  "61102091_4727" => "11220143-471",
  "61046292_4727" => "11220143-472",
  "61102093_4728" => "11220143-473",
  "61046391_4728" => "11220143-474",
  "61103099_4728" => "11220143-475",
  "61102093_4729" => "11220143-476",
  "61046292_4729" => "11220143-477",
  "61046292_4729" => "11220143-478",
  "61046292_4729" => "11220143-479",
  "61046391_4729" => "11220143-480",
  "61103092_4730" => "11220143-481",
  "61046292_4730" => "11220143-482",
  "61102091_4731" => "11220143-483",
  "61046292_4731" => "11220143-484",
  "61102091_4733" => "11220143-485",
  "61046292_4733" => "11220143-486",
  "61012099_4814" => "11220143-487",
  "61034304_4814" => "11220143-488",
  "61034204_4814" => "11220143-489",
  "61012099_4815" => "11220143-490",
  "61034204_4815" => "11220143-491",
  "61034204_4815" => "11220143-492",
  "61034304_4815" => "11220143-493",
  "61102093_4817" => "11220143-494",
  "61034304_4817" => "11220143-495",
  "61034204_4817" => "11220143-496",
  "61034204_4817" => "11220143-497",
  "61012099_4818" => "11220143-498",
  "61034204_4818" => "11220143-499",
  "61012099_4821" => "11220143-500",
  "61034204_4821" => "11220143-501",
  "61034204_4821" => "11220143-502",
  "61022099_4824" => "11220143-503",
  "61046292_4824" => "11220143-800",
  "61022099_4825" => "11220143-505",
  "61046292_4825" => "11220143-800",
  "61103093_4826" => "11220143-507",
  "61103092_4826" => "11220143-508",
  "61046391_4826" => "11220143-509",
  "62045392_4952" => "11220143-817",
  "61045392_4953" => "11220143-511",
  "62045901_4954" => "11220143-512",
  "62045392_4955" => "11220143-513",
  "62045299_4956" => "11220143-514",
  "61045392_4958" => "11220143-515",
  "62045392_4959" => "11220143-516",
  "62171099_4959" => "11220143-517",
  "61044392_4961" => "11220143-799",
  "61044392_4961" => "11220143-519",
  "62044392_4962" => "11220143-520",
  "61044392_4963" => "11220143-521",
  "62044292_4964" => "11220143-522",
  "61044392_4966" => "11220143-523",
  "61044299_4966" => "11220143-524",
  "61044392_4967" => "11220143-525",
  "62044392_4968" => "11220143-526",
  "62044392_4969" => "11220143-815",
  "61044392_4970" => "11220143-528",
  "62044392_4971" => "11220143-529",
  "62044392_4974" => "11220143-530",
  "62171099_4974" => "11220143-531",
  "62044392_4975" => "11220143-532",
  "62044392_4977" => "11220143-533",
  "61044299_4978" => "11220143-534",
  "62044492_4980" => "11220143-535",
  "61044392_4981" => "11220143-536",
  "62171099_4981" => "11220143-537",
  "61044299_4982" => "11220143-538",
  "62044392_4983" => "11220143-539",
  "62044492_4984" => "11220143-540",
  "61044299_4985" => "11220143-541",
  "61044392_4986" => "11220143-542",
  "61103099_4986" => "11220143-543",
  "61044392_4987" => "11220143-544",
  "61044299_4988" => "11220143-545",
  "61044392_4989" => "11220143-799",
  "61044299_4990" => "11220143-547",
  "62063003_4991" => "11220143-548",
  "61045392_4991" => "11220143-549",
  "61102093_4992" => "11220143-550",
  "61045392_4992" => "11220143-551",
  "61102093_4993" => "11220143-552",
  "61045392_4993" => "11220143-553",
  "62044491_5555" => "11220143-554",
  "62044492_5555" => "11220143-555",
  "61051003_7043" => "11220143-556",
  "61051004_7043" => "11220143-557",
  "61102002_7044" => "11220143-558",
  "61102091_7044" => "11220143-559",
  "61102002_7047" => "11220143-560",
  "61102091_7047" => "11220143-561",
  "61102002_7048" => "11220143-562",
  "61102091_7048" => "11220143-563",
  "61102002_7049" => "11220143-564",
  "61102091_7049" => "11220143-565",
  "61102002_7050" => "11220143-566",
  "61102091_7050" => "11220143-567",
  "61102002_7050" => "11220143-568",
  "61102091_7050" => "11220143-569",
  "61102002_7051" => "11220143-570",
  "61102091_7051" => "11220143-571",
  "61102002_7056" => "11220143-572",
  "61102091_7056" => "11220143-573",
  "61102002_7056" => "11220143-574",
  "61102091_7056" => "11220143-575",
  "61102002_7057" => "11220143-576",
  "61102091_7057" => "11220143-577",
  "61103099_7061" => "11220143-578",
  "61102002_7062" => "11220143-579",
  "61061092_7062" => "11220143-580",
  "61102002_7063" => "11220143-581",
  "61102091_7063" => "11220143-582",
  "61102002_7065" => "11220143-583",
  "61102091_7065" => "11220143-584",
  "61102002_7068" => "11220143-585",
  "61102091_7068" => "11220143-586",
  "61099003_7069" => "11220143-587",
  "61099091_7069" => "11220143-588",
  "61102002_7070" => "11220143-589",
  "61102091_7070" => "11220143-590",
  "61102002_7071" => "11220143-591",
  "61102091_7071" => "11220143-592",
  "61102002_7073" => "11220143-593",
  "61099091_7073" => "11220143-594",
  "61102002_7077" => "11220143-595",
  "61102091_7077" => "11220143-804",
  "61102002_7078" => "11220143-597",
  "61091099_7078" => "11220143-598",
  "61102002_7080" => "11220143-599",
  "61102091_7080" => "11220143-600",
  "61051003_7124" => "11220143-601",
  "61051004_7124" => "11220143-602",
  "61051003_7126" => "11220143-603",
  "61051004_7126" => "11220143-604",
  "62052091_7129" => "11220143-605",
  "62052092_7129" => "11220143-606",
  "62052091_7131" => "11220143-607",
  "62052092_7131" => "11220143-608",
  "62052091_7132" => "11220143-609",
  "62052092_7132" => "11220143-610",
  "62052091_7133" => "11220143-611",
  "62052092_7133" => "11220143-612",
  "62052091_7134" => "11220143-613",
  "62052092_7134" => "11220143-614",
  "62064092_7136" => "11220143-615",
  "62063002_7137" => "11220143-616",
  "62063003_7137" => "11220143-617",
  "62064091_7140" => "11220143-618",
  "62064091_7140" => "11220143-619",
  "62064091_7141" => "11220143-620",
  "62064092_7141" => "11220143-621",
  "62064091_7143" => "11220143-622",
  "62064092_7143" => "11220143-623",
  "62046310_7203" => "11220143-624",
  "62046307_7203" => "11220143-625",
  "62171099_7203" => "11220143-626",
  "62019399_7322" => "11220143-627",
  "61103093_7324" => "11220143-628",
  "61103093_7325" => "11220143-629",
  "61103093_7327" => "11220143-630",
  "61103093_7328" => "11220143-631",
  "61143099_7329" => "11220143-810",
  "61143099_7329" => "11220143-811",
  "61103093_7330" => "11220143-634",
  "61103093_7335" => "11220143-805",
  "62029391_7337" => "11220143-636",
  "62029392_7337" => "11220143-637",
  "61103093_7402" => "11220143-638",
  "61103093_7403" => "11220143-639",
  "61102004_7404" => "11220143-640",
  "61023003_7405" => "11220143-641",
  "61023002_7405" => "11220143-642",
  "62029291_7406" => "11220143-643",
  "62029292_7406" => "11220143-644",
  "62029391_7407" => "11220143-645",
  "62021391_7414" => "11220143-646",
  "62021391_7415" => "11220143-647",
  "62029391_7418" => "11220143-648",
  "62021391_7419" => "11220143-649",
  "61102004_7454" => "11220143-650",
  "61102093_7454" => "11220143-651",
  "61102004_7458" => "11220143-652",
  "61102093_7458" => "11220143-653",
  "61102004_7461" => "11220143-654",
  "61102093_7461" => "11220143-655",
  "62019399_7463" => "11220143-656",
  "62011391_7467" => "11220143-657",
  "62011391_7470" => "11220143-658",
  "62019399_7472" => "11220143-659",
  "62011391_7473" => "11220143-660",
  "62011391_7474" => "11220143-661",
  "63079099_7474" => "11220143-662",
  "61012002_7479" => "11220143-663",
  "61012099_7479" => "11220143-664",
  "61034302_7522" => "11220143-665",
  "61034304_7522" => "11220143-666",
  "62034291_7528" => "11220143-804",
  "62034292_7528" => "11220143-668",
  "62034294_7530" => "11220143-813",
  "62034295_7530" => "11220143-814",
  "61046901_7534" => "11220143-671",
  "61046901_7534" => "11220143-672",
  "61046392_7535" => "11220143-673",
  "61046391_7535" => "11220143-674",
  "62046294_7539" => "11220143-675",
  "61102002_7545" => "11220143-676",
  "61102091_7545" => "11220143-803",
  "61046292_7545" => "11220143-678",
  "61046391_7711" => "11220143-679",
  "61046391_7712" => "11220143-680",
  "61102004_7719" => "11220143-681",
  "61046292_7719" => "11220143-682",
  "61103093_7720" => "11220143-683",
  "61046392_7720" => "11220143-684",
  "61046391_7720" => "11220143-685",
  "61102004_7720" => "11220143-686",
  "61012002_7806" => "11220143-687",
  "61012099_7806" => "11220143-688",
  "61034204_7806" => "11220143-689",
  "61102004_7807" => "11220143-690",
  "61034202_7807" => "11220143-691",
  "61034204_7807" => "11220143-692",
  "61012002_7808" => "11220143-693",
  "61034202_7808" => "11220143-694",
  "61034204_7808" => "11220143-695",
  "61013091_7808" => "11220143-696",
  "61102004_7809" => "11220143-697",
  "61034202_7809" => "11220143-698",
  "61034204_7809" => "11220143-699",
  "61034302_7809" => "11220143-700",
  "61034304_7809" => "11220143-701",
  "61023003_7810" => "11220143-702",
  "61023002_7810" => "11220143-703",
  "61046391_7810" => "11220143-704",
  "61045392_7944" => "11220143-705",
  "61045392_7945" => "11220143-706",
  "61045392_7946" => "11220143-707",
  "62045391_7947" => "11220143-708",
  "61045392_7947" => "11220143-709",
  "61045392_7948" => "11220143-710",
  "62045392_7950" => "11220143-817",
  "61045392_7952" => "11220143-712",
  "61044499_7957" => "11220143-713",
  "61044391_7960" => "11220143-714",
  "61044392_7960" => "11220143-715",
  "62044391_7962" => "11220143-716",
  "62044392_7962" => "11220143-717",
  "61044499_7963" => "11220143-718",
  "61102004_7965" => "11220143-719",
  "61044202_7965" => "11220143-720",
  "61044299_7965" => "11220143-721",
  "61102004_7965" => "11220143-722",
  "61044391_7965" => "11220143-798",
  "61044392_7965" => "11220143-799",
  "62044391_7967" => "11220143-725",
  "62044392_7967" => "11220143-726",
  "62044391_7968" => "11220143-727",
  "62044392_7968" => "11220143-728",
  "62044391_7970" => "11220143-729",
  "62044392_7970" => "11220143-730",
  "62044491_7971" => "11220143-731",
  "62044492_7971" => "11220143-732",
  "62044391_7972" => "11220143-733",
  "62044392_7972" => "11220143-734",
  "61103093_7974" => "11220143-735",
  "61103099_7974" => "11220143-736",
  "61044202_7974" => "11220143-737",
  "62044292_7974" => "11220143-738",
  "61044403_7975" => "11220143-739",
  "61044499_7975" => "11220143-740",
  "61044202_7976" => "11220143-741",
  "61044299_7976" => "11220143-742",
  "61112099_9296" => "11220143-743",
  "61112011_9302" => "11220143-744",
  "61112011_9302" => "11220143-745",
  "61112011_9302" => "11220143-746",
  "61112011_9302" => "11220143-747",
  "61112011_9306" => "11220143-748",
  "61112011_9306" => "11220143-749",
  "61112011_9306" => "11220143-750",
  "61112011_9306" => "11220143-751",
  "65050099_9320" => "11220143-752",
  "65050099_9321" => "11220143-753",
  "63013001_9755" => "11220143-754",
  "61112099_9765" => "11220143-755",
  "61112099_9765" => "11220143-756",
  "63013001_9777" => "11220143-757",
  "63013001_9778" => "11220143-758",
  "63013001_9779" => "11220143-759",
  "63014001_9783" => "11220143-760",
  "61112099_10828" => "11220143-761",
  "61152901_10828" => "11220143-762",
  "61112011_10831" => "11220143-763",
  "61159501_10831" => "11220143-764",
  "61112011_10831" => "11220143-765",
  "61159501_10831" => "11220143-766",
  "61112011_10831" => "11220143-767",
  "61159501_10831" => "11220143-768",
  "61071199_10853" => "11220143-769",
  "61071199_10853" => "11220143-770",
  "61071199_10853" => "11220143-771",
  "61071199_10854" => "11220143-772",
  "61071199_10854" => "11220143-773",
  "61071199_10854" => "11220143-774",
  "61071199_10855" => "11220143-775",
  "61071199_10855" => "11220143-776",
  "61071199_10855" => "11220143-777",
  "61152201_10861" => "11220143-778",
  "61152201_10862" => "11220143-779",
  "61152201_10863" => "11220143-780",
  "61152201_10863" => "11220143-781",
  "61152901_10866" => "11220143-782",
  "61152901_10868" => "11220143-812",
  "61159501_10871" => "11220143-784",
  "61159501_10871" => "11220143-785",
  "61159501_10871" => "11220143-786",
  "61159501_10873" => "11220143-787",
  "61159501_10873" => "11220143-788",
  "61159501_10873" => "11220143-789",
  "61159501_10874" => "11220143-790",
  "61159501_10874" => "11220143-791",
  "61159501_10874" => "11220143-792",
  "61159501_10876" => "11220143-793",
  "65050099_10903" => "11220143-794",
  "63079099_19796" => "11220143-795",
  "63079099_19797" => "11220143-796",
  "63079099_19799" => "11220143-797",
  "61112099_19810" => "11220143-798",
  "43040001_2465" => "11220144",
  "43040001_4410" => "11220144-1",
  "43040001_4352" => "11220144-2",
  "43040001_2363" => "11220144-3",
  "43040001_2363" => "11220144-176",
  "43040001_2784" => "11220144-176",
  "43040001_2784" => "11220144-176",
  "43040001_4352" => "11220144-176",
  "43040001_4351" => "11220144-8",
  "43040001_7336" => "11220144-176",
  "43040001_7336" => "11220144-176",
  "43040001_7417" => "11220144-11",
  "43040001_4353" => "11220144-12",
  "43040001_2410" => "11220144-174",
  "43040001_2410" => "11220144-174",
  "43040001_4412" => "11220144-15",
  "43040001_4418" => "11220144-175",
  "43040001_4418" => "11220144-17",
  "43040001_4419" => "11220144-18",
  "43040001_2481" => "11220144-19",
  "43040001_2414" => "11220144-20",
  "43040001_2414" => "11220144-21",
  "43040001_2415" => "11220144-176",
  "43040001_2415" => "11220144-176",
  "43040001_4472" => "11220144-174",
  "43040001_2481" => "11220144-174",
  "43040001_4472" => "11220144-26",
  "42029201_10922" => "11220144-27",
  "42029201_19802" => "11220144-28",
  "42022201_19796" => "11220144-29",
  "42022201_19797" => "11220144-30",
  "42022201_19799" => "11220144-31",
  "42029201_19796" => "11220144-32",
  "42029201_19797" => "11220144-33",
  "42029201_19799" => "11220144-34",
  "42021201_19805" => "11220144-35",
  "95030012_19810" => "11220144-36"
];

$root = $_SERVER['DOCUMENT_ROOT'];

require $root . "/pltoolbox/mayoral/resources/specific_classes/csv_to_utf8.php";
require $root . '/pltoolbox/Resources/PHP/Utilities/initialScript.php';
require $root . '/pltoolbox/Resources/vendor/autoload.php';

$system_callback = [];
$anexo30 = array();
$trato_preferencial = array();
$precios_estimados = array();
$txt_array = array();
$identificadores = array();
$today = date('Y-m-d');
$hm = date('Hi');
$csv_file = array();


$codigo_paises = array(
  "BD"=>"BGD",
  "EG"=>"EGY",
  "ES"=>"ESP",
  "IN"=>"IND",
  "KH"=>"KHM",
  "MA"=>"MAR",
  "PK"=>"PAK",
  "PL"=>"POL",
  "PT"=>"PRT",
  "TR"=>"TUR",
  "VN"=>"VNM",
  "TH"=>"THA",
  "CN"=>"CHN",
  "PT"=>"PRT",
  "TW"=>"TWN",
  "IT"=>"ITA",
  "MM"=>"MMR"
);

$uvnom = "UVNOM" . $_POST['uvnom'];
$fecha_factura = date('d/m/Y', strtotime($_POST['fecha_factura']));
// $fecha_factura = date_format($fecha_factura, 'd/m/Y');
$contenedor = $_POST['contenedor'];

$datos_pbs = array();
$pbs = array();
$nopbs = array();
$pbs_origenes = array();
$pbs_descripciones = array();

$alertas = array();
$advertencias = array();

$anexo30_query = $db->query('SELECT fraccion FROM mayoral_identificadores_anexo30');
while ($item = $anexo30_query->fetch_assoc()) {
  $anexo30[] = $item['fraccion'];
}

$trato_preferencial_query = $db->query('SELECT 3_siglas 3siglas FROM mayoral_trato_preferencial');
while ($item = $trato_preferencial_query->fetch_assoc()) {
  $trato_preferencial[] = $item['3siglas'];
}

$precios_estimados_query = $db->query('SELECT fraccion, precio_estimado FROM mayoral_precio_estimado');
while ($item = $precios_estimados_query->fetch_assoc()) {
  $precios_estimados[$item['fraccion']] = $item['precio_estimado'];
}

$identificadores_aplicables_query = $db->prepare("SELECT * FROM mayoral_identificadores mi LEFT JOIN mayoral_identificadores_fracciones mif ON mi.pk_identificador = mif.fk_identificador WHERE mif.fraccion = ? OR mif.fraccion = ? OR mif.fraccion = ?");
$identificadores_excepciones_query = $db->prepare("SELECT * FROM mayoral_identificadores mi LEFT JOIN mayoral_identificadores_fraccion_excepciones mife ON mi.pk_identificador = mife.fk_identificador WHERE mife.fraccion = ? OR mife.fraccion = ? OR mife.fraccion = ?");

if (!$identificadores_aplicables_query) {
    error_log("Error en prepare queries aplicables: " . $db->error);
}

if (!$identificadores_excepciones_query) {
    error_log("Error en prepare queries exceppciones: " . $db->error);
}


$file = $_FILES;
$text_file = "";

$authorized_files = ['csv'];
$extension = pathinfo($file['file']['name'],PATHINFO_EXTENSION);
$test_extension = in_array($extension, $authorized_files);


$documented_headers = ["﻿AÑO","FACTURA","ARTICULO","PIEZA","RANGO","DESCRIPCION ","DESCRIPCION MX","COMPOSICION","COMP. FORRO","TARIC","MX HS CODE","SUBDIVI","CANTIDAD","PRECIO UN.","IMPORTE TOT,","MONEDA","ORIGEN","PESO NETO","PESO BRUTO","FACERR","SECCION ","MARCA","T1","T2","T3","T4","T5","T6","T7","T8","T9","T10","TK1","TK2","TK3","TK4","TK5","TK6","TK7","TK8","TK9","TK10","C1","C2","C3","C4","C5","C6","C7","C8","C9","C10","PUNTO / PLANA","SEXO","UMC","UMT"
];

$documented_headers = [
  "ANO",
  "FACTURA",
  "ARTICULO",
  "PIEZA",
  "RANGO",
  "DESCRIPCION ",
  "DESCRIPCION MX",
  "COMPOSICION",
  "COMP. FORRO",
  "TARIC",
  "MX HS CODE",
  "SUBDIVI",
  "CANTIDAD",
  "PRECIO UN.",
  "IMPORTE TOT,",
  "MONEDA",
  "ORIGEN",
  "PESO NETO",
  "PESO BRUTO",
  "FACERR",
  "SECCION ",
  "MARCA",
  "T1",
  "T2",
  "T3",
  "T4",
  "T5",
  "T6",
  "T7",
  "T8",
  "T9",
  "T10",
  "TK1",
  "TK2",
  "TK3",
  "TK4",
  "TK5",
  "TK6",
  "TK7",
  "TK8",
  "TK9",
  "TK10",
  "C1",
  "C2",
  "C3",
  "C4",
  "C5",
  "C6",
  "C7",
  "C8",
  "C9",
  "C10",
  "PUNTO / PLANA",
  "SEXO",
  "UMC",
  "UMT",
];


if (!$test_extension) {
  $system_callback['code'] = 500;
  $system_callback['message'] = "Los archivos con extensión $extension no están permitidos. Favor de subir un archivo CSV.";
  exit_script($system_callback);
}

// $conversion = new convert_csv_to_utf8($file['file']['tmp_name']);

// error_log("Conversion: " . var_export($conversion));

$file_handle = fopen($file['file']['tmp_name'], 'r');

$headers = fgetcsv($file_handle,1000);
$invoice_items = array();
$facturas = array();
$valor_factura = array();
$today = date('Y-m-d', strtotime('today'));

$num_headers = count($documented_headers);
// error_log($documented_headers[0]);

// error_log(
//   "Documented Header encoding: " . mb_detect_encoding($documented_headers[0]) .
//   ", Length: " . strlen($documented_headers[0]) .
//   ", string: " . utf8_decode($documented_headers[0])
// );

// error_log(
//   "Real Header encoding UTF8: " . mb_detect_encoding(utf8_encode($headers[0])) .
//   ", Length: " . strlen(utf8_encode($headers[0])) .
//   ", string: " . utf8_encode($headers[0])
// );
//
// error_log(
//   "Real Header encoding: " . mb_detect_encoding($headers[0]) .
//   ", Length: " . strlen($headers[0]) .
//   ", string: " . $headers[0]
// );

for ($i=0; $i < $num_headers; $i++) {
  $internal_header = mb_strtoupper($documented_headers[$i]);
  $document_header = mb_strtoupper($headers[$i]);

  $internal_header = utf8_decode($internal_header);
  $document_header = utf8_decode($document_header);

  $internal_header = $documented_headers[$i];
  $document_header = $headers[$i];

  if (!($internal_header == $document_header)) {
    $system_callback['code'] = 500;
    $system_callback['message'] = "Los encabezados no son correctos. Se esperaba $internal_header; y se encontró: " . $document_header;
    error_log($system_callback['message']);
    error_log(mb_detect_encoding($documented_headers[$i]));
    exit_script($system_callback);
  }
}

while ($row = fgetcsv($file_handle,1000)) {
  $invoice_items[] = $row;
}
fclose($file_handle);

$i = 1;
$permisos = "";
foreach ($invoice_items as $item) {
  $i++;
  $pais_origen = "";
  $identificadores_item = array();
  $aplicar_permiso = false;


  $invoice_num = substr($item[1], 0, 2) . "." . substr($item[1], -3);
  $invoice_num = $item[1];
  $importe_total_factura += (double)$item[14];
  $numero_parte = $invoice_num . $item[2] . $item[3] . $i . $item[10] . $hm . "x";

  //Si la marca es New Born, se debe cambiar por mayoral.
  // $marca = str_replace('MAYORAL     ', 'MAYORAL', $marca);
  $marca = preg_replace('/[^a-zA-Z0-9&](\s)/', '', $item[21]);
  $marca = $marca == "NEWBORN " ? "MAYORAL" : $marca;

  if ($marca == "MAYORAL     ") {
    $advertencias[$numero_parte . "_" . $i] = "La marca es extraña. Marca: $marca";
  }

  //Agregar Y DISEÑO a todas las marcas excepto NUKUTAVAKE (o si hay registros vacíos).
  if (!($marca == 'NUKUTAVAKE' ||$marca == "" ||$marca == " ")) {
    $test = substr($marca, -1);
    if($test == " "){
      $marca .= "Y DISENO";
    } else {
      $marca .= " Y DISENO";
    }
  }

  if ($item[1] == "") {
    continue;
  }


  $c_umt = 0;
  //Calcular Cantidad UMT!!
    //54 es UMC
    //55 es UMT
        // Codigo 9 es Par
        // Codigo 6 es Pieza
  if ($item[54] == $item[55]) { //Si UMC = UMT.
    $c_umt = $item[12];
  } elseif ($item[55] == 1) { //Si UMT = Kilo, usa el peso unitario que viene en la factura.
    $c_umt = $item[17];
  } elseif ($item[55] == 9 && $item[54] == 6) { //Si UMC es Pieza y UMT es PAR. Entonces CANTIDAD COMERCIAL * 2.
    $c_umt = $item[12] / 2;
  } elseif ($item[55] == 6 && $item[54] == 9) { //Si UMC es Par y UMT es Pieza. Entonces Cantidad Comercial / 2.
    $c_umt = $item[12] * 2;
  } else {
    // Record error on this PN.
  }


  if (array_key_exists($item[16], $codigo_paises)) {
    $pais_origen = $codigo_paises[$item[16]];
  } else {
    $alertas[] = array(
      'line_item'=>$i,
      'message'=>"El codigo de país $item[16] no existe en el programa.",
      'comentarios'=>"Porfavor reportarlo a sistemas para corregir."
    );
  }

  $txt_array[$invoice_num]['header'] = array(
    $invoice_num,   //NumeroFactura
    $invoice_num,   //NumeroFactura - reemplaza número de órden
    $fecha_factura,         //Fecha -- Hoy es default
    'ESP',          //Siempre se pone ESP(España) como país facturación
    '',           //Siempre se pone MA(Málaga) como entidad de facturación
    $item[15],      //Moneda --
    'CIF',          //Poner un campo para seleccionar el INCOTERM.
    $importe_total_factura, //Valor Moneda Extranjera
    $importe_total_factura, //Valor Comercial - Factura
    0,0,0,0,0,      //Flete, Seguros, Embalajes, Incrementables, Deducibles
    1,              //FactorMonedaExtranjera
  );

  $txt_array[$invoice_num]['items'][] = array(
    $numero_parte,   //Numero de Parte,
    remove_n($item[6]),                                               //Descripcion MX
    "",                                                     //Descripcion Inglés
    $item[12],                                              //Cantidad UMC
    $item[54],                                              //UMC
    $item[13],                                              //PrecioUnitario
    2,0,                                                    //UnidadPesoUnitario - PesoUnitario
    $item[10],                                              //Fraccion
    $c_umt,                                                 //CantidadUMT
    // "",
    (double) $c_umt / $item[12],                            //FactorAjuste
    $pais_origen,                                           //PaisOrigen,
    0,                                                      //ValorAgregado
    $marca,                                                  //Marca,
    $item[2],                                               //Modelo
    ""                                                       //Serie se manda en blanco.
  );
  $capitulo = substr($item[10], 0,2);
  $partida_fraccion = substr($item[10], 0, 4);

  //Si la fracción esta en el listado de precios estimados, lo revisa para agergar identificador EX o arrojar una alerta.
  if ($item[55] == 1) {
    $precio_unitario_tarifa = $item[14] / $item[17];
  } else {
    $precio_unitario_tarifa = $item[13];
  }
  if (  array_key_exists($item[10], $precios_estimados)) {
    $precio_estimado_item = $precios_estimados[$item[10]];
    if ($precio_unitario_tarifa > $precio_estimado_item) {
      if ($capitulo == 64) {
        $identificadores[$numero_parte . "_" . $i]['identificadores']['EX'] = array($numero_parte, 'EX', '29');
      } elseif ($capitulo >= 50 && $capitulo <= 63) {
        $identificadores[$numero_parte . "_" . $i]['identificadores']['EX'] = array($numero_parte, 'EX', '31');
      } elseif ($capitulo = 94) {
        $identificadores[$numero_parte . "_" . $i]['identificadores']['EX'] = array($numero_parte, 'EX', '31');
      }
    } else {
      $alertas[] = array(
        'line_item'=>$i,
        'message'=>'Este producto esta por debajo del precio estimado.',
        'comentarios'=>"Precio Estimado: $precio_estimado_item - Precio Unitario: $item[13]"
      );
    }
  }

  //Aplicar identificador TL - EMU si eta en la lista de trato preferencial.
  if (in_array($pais_origen, $trato_preferencial)) {
    $identificadores[$numero_parte . "_" . $i]['identificadores']['TL'] = array($numero_parte, 'TL', 'EMU');
  }

  //Si la fracción pertenece al Anexo 30, agrega el identificador MC correspondiene, o arroja una alerta, si no encuentra que MC poner.
  if (in_array($item[10], $anexo30)) {
    if ($marca == "NUKUTAVAKE") {
      $identificadores[$numero_parte . "_" . $i]['identificadores']['MC'] = array($numero_parte, 'MC', '2', '1', '1');
    } elseif ($marca == "MAYORAL Y DISENO" ||$marca == "ABEL & LULA Y DISENO" ||$item[10] == 39262099) {
      $identificadores[$numero_parte . "_" . $i]['identificadores']['MC'] = array($numero_parte, 'MC', '2', '1', '4');
    } elseif ($capitulo == 42) {
      $identificadores[$numero_parte . "_" . $i]['identificadores']['MC'] = array($numero_parte, 'MC', '4', '4');
    } else {
      $advertencias[$numero_parte . "_" . $i] = "No se encontró que identificador aplicar. Marca: $marca";
    }
  }

  $identificadores_aplicables_query->bind_param('sss', $capitulo, $partida_fraccion, $item[10]);
  $identificadores_aplicables_query->execute();
  $identificadores_aplicables = $identificadores_aplicables_query->get_result();

  while ($idents = $identificadores_aplicables->fetch_assoc()) {
    $folio = "";
    $comple1 = $idents['identificador'] == "PB" ? $uvnom : $idents['complemento1'];
    // $comple3 = $idents['identificador'] == "PB" ? "" : $idents['complemento3'];
    $identificadores[$numero_parte . "_" . $i]['identificadores'][$idents['pk_identificador']] = array($numero_parte, $idents['identificador'], $comple1, $idents['complemento2'], $idents['complemento3'], $idents['complemento4']);
    if ($idents['identificador'] == "PB") {
      $clave = $item[10] . "_" . $item[2];
      $folio = $folios_uvas[$clave];

      error_log($clave);

      if ($folio = "") {
        error_log("La linea $i debe tener folio, y no se encontró\n", 0, "/var/log/apache2/special.log");
      }

      $permisos .=
        $numero_parte . "|" .
        "NM|" .
        $idents['complemento2'] . "|" .
        $folio . "|||"
      ;
    }
  }

  $identificadores_excepciones_query->bind_param('sss', $capitulo, $partida_fraccion, $item[10]);
  $identificadores_excepciones_query->execute();
  $identificadores_excepciones = $identificadores_excepciones_query->get_result();

  while ($idents = $identificadores_excepciones->fetch_assoc()) {
    unset($identificadores[$numero_parte . "_" . $i]['identificadores'][$idents['pk_identificador']]);
  }
  $no_pb = true;
  foreach ($identificadores[$numero_parte . "_" . $i]['identificadores'] as $identificador) {
    if ($identificador[1] == "PB") {
      $no_pb = false;
      $datos_pbs[$identificador[1].",".$identificador[2].",".$identificador[3]]['items']++;
      $datos_pbs[$identificador[1].",".$identificador[2].",".$identificador[3]]['umcs'] += $item[12];
      $datos_pbs[$identificador[1].",".$identificador[2].",".$identificador[3]]['origenes'][]= $pais_origen;
      $datos_pbs[$identificador[1].",".$identificador[2].",".$identificador[3]]['descripciones'][] = remove_n($item[6]);
    }
  }
  if ($no_pb) {
    $datos_pbs['sin_norma']['items']++;
    $datos_pbs['sin_norma']['umcs'] += $item[12];
  }

}

// $pbs_origenes = array_unique($pbs_origenes);
// $pbs_descripciones = array_unique($pbs_descripciones);
// $pbs_origenes_unique = array();
// $pbs_descripciones_unique = array();

// foreach ($pbs_origenes as $origen) {
//   $handler_origen = explode("~", $origen);
//   $pbs_origenes_unique[$handler_origen[0]][] = $handler_origen[1];
// }

// foreach ($pbs_descripciones as $descripcion) {
//   $handler_descripcion = explode("~", $descripcion);
//   $pbs_descripciones_unique[$handler_descripcion[0]][] = $handler_descripcion[1];
// }


$uniq = uniqid();
$csv_file = fopen($root . "/pltoolbox/mayoral/resources/TempFiles/csv_file_{$uniq}.csv", "w");
$identificadores_csv = fopen($root . "/pltoolbox/mayoral/resources/TempFiles/csv_identificadores_{$uniq}.csv", "w");

if (count($alertas) > 0) {
  foreach ($alertas as $alerta) {
    $system_callback['alertas'] .= "<tr><td>$alerta[line_item]</td><td>$alerta[message]</td><td>$alerta[comentarios]</td></tr>";
  }

  $system_callback['code'] = 2;
  exit_script($system_callback);
}

foreach ($txt_array as $factura) {
  foreach ($factura['header'] as $valor_header) {
    $txt_file .= $valor_header . "|";
  }



  fputcsv($csv_file, explode(",", "Numero Factura,	Número Orden,	Fecha Factura,	Pais Factura,	Entidad Factura,	Moneda,	Incoterm,	Valor Total Factura,	Valor Total USD,	Flete,	Seguros,	Embalajes,	Incrementables,	Deducibles,	Factor Moneda Extranjera"));
  fputcsv($csv_file, $factura['header']);

  fputcsv($csv_file, explode(",","Numero Parte,	Descripcion Español,	Descripcion Ingles,	Cantidad UMC,	UMC,	Precio Unitario,	Unidad Peso Unitario,	Peso Unitario,	Fraccion,	Cantidad UMT,	UMT,	Pais Origen,	Valor Agregado,	Marca,	Modelo,	Serie"));

  foreach ($factura['items'] as $item) {
    foreach ($item as $valor_item) {
      $txt_file .= rtrim($valor_item) . "|";
    }
    fputcsv($csv_file, $item);

  }
  $txt_file = rtrim($txt_file, "|");
  // $txt_file = substr($txt_file, 0, -1);
  $txt_file .= "^";
}

$txt_file = rtrim($txt_file, "^");
$txt_file .= "~";

$identificadores_print = "";

foreach ($identificadores as $identificadores_item) {
  foreach($identificadores_item['identificadores'] as $identificador_parte){
    fputcsv($identificadores_csv, $identificador_parte);
    for ($i=0; $i < 7; $i++) {
      $identificadorparte = isset($identificador_parte[$i]) ? $identificador_parte[$i] : "";
      $txt_file .= $identificadorparte . "|";
    }
  }
}

$txt_file .= "@$permisos";

$txt_file = str_replace("ñ","n",$txt_file);
$txt_file = str_replace("Ñ","N",$txt_file);

$txt_file_path = $root . "/pltoolbox/mayoral/resources/TempFiles/txt_file_{$uniq}.txt";
file_put_contents($txt_file_path, $txt_file);
fclose($csv_file);

foreach ($datos_pbs as $norma_id => $datos_norma) {
  $datos_pbs[$norma_id]['origenes'] = array_unique($datos_pbs[$norma_id]['origenes']);
  $datos_pbs[$norma_id]['descripciones'] = array_unique($datos_pbs[$norma_id]['descripciones']);
}

$pbs_origenes_unique = array_unique($pbs_origenes);
$pbs_descripciones_unique = array_unique($pbs_descripciones);

$xls = new Spreadsheet();
$xlsActive = $xls->getActiveSheet();
$rows_var = "FGHIJKLMNOPQRSTUVWXY";

$xlsActive->setCellValue('B3', "Norma");
$xlsActive->setCellValue('C3', "Items");
$xlsActive->setCellValue('D3', "UMCs");

$i = 3;
foreach ($datos_pbs as $norma => $datos) {
  $i++;
  $xlsActive->setCellValue("B$i", utf8_encode($norma));
  $xlsActive->setCellValue("C$i", utf8_encode($datos['items']));
  $xlsActive->setCellValue("D$i", utf8_encode($datos['umcs']));
}


$c1=0;
foreach ($datos_pbs as $norma => $datos) {

  if ($norma == "sin_norma") {
    continue;
  }

  $r=2;
  $c2=$c1+1;
  $xlsActive->mergeCells("$rows_var[$c1]$r:$rows_var[$c2]$r");
  $xlsActive->setCellValue("$rows_var[$c1]$r", utf8_encode($norma));
  $r_data = 3;
  $xlsActive->setCellValue("$rows_var[$c1]$r_data", "Origenes");
  foreach ($datos['origenes'] as $origen) {
    $r_data++;
    $xlsActive->setCellValue("$rows_var[$c1]$r_data", utf8_encode($origen));
  }
  $r_data = 3;
  $xlsActive->setCellValue("$rows_var[$c2]$r_data", "Descripciones");
  foreach ($datos['descripciones'] as $descripcion) {
    $r_data++;
    $xlsActive->setCellValue("$rows_var[$c2]$r_data", utf8_encode($descripcion));
  }

  $c1++;
  $c1++;
}

$columns = strlen($rows_var);
for ($i=0; $i < $columns; $i++) {
  $xlsActive->getColumnDimension($rows_var[$i])->setAutoSize(true);
}


$writeXLS = new \PhpOffice\PhpSpreadsheet\Writer\Xlsx($xls);

$xls_file = $root . "/pltoolbox/mayoral/resources/TempFiles/uvas_file_{$uniq}.xlsx";
// $file = "/home/esantos/Crons/TempFiles/detalle_pedimentos_$cliente_rfc.xlsx";
$writeXLS->save($xls_file);


// $system_callback['pbs'] = $datos_pbs;
$system_callback['code'] = 1;
$system_callback['uniq'] = $uniq;
// $system_callback['advertencias'] = $advertencias;

exit_script($system_callback);




 ?>
